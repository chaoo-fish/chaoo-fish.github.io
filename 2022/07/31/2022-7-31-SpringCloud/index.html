

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Chaoo">
  <meta name="keywords" content="Java, Blog">
  
    <meta name="description" content="Springcloudå­¦ä¹ ç¬”è®°">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringcloudAlibaba-">
<meta property="og:url" content="http://example.com/2022/07/31/2022-7-31-SpringCloud/index.html">
<meta property="og:site_name" content="éšé£">
<meta property="og:description" content="Springcloudå­¦ä¹ ç¬”è®°">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208022245839.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208022244198.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208031553988.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041129124.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041135753.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136596.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136886.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041140341.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041141298.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041141439.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136886.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041146409.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041156234.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041158739.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041154864.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041200021.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041449241.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041449733.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041450222.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041454502.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041455454.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041507701.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041510648.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208061713482.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051010414.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051011311.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051023685.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051024865.png">
<meta property="article:published_time" content="2022-07-30T16:00:00.000Z">
<meta property="article:modified_time" content="2022-07-30T16:00:00.000Z">
<meta property="article:author" content="Chaoo">
<meta property="article:tag" content="Springcloud">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208022245839.png">
  
  
  
  <title>SpringcloudAlibaba- - éšé£</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Chaoo</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringcloudAlibaba-"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-31 00:00" pubdate>
          2022å¹´7æœˆ31æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          43k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          357 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringcloudAlibaba-</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="å¾®æœåŠ¡ä»‹ç»â³"><a href="#å¾®æœåŠ¡ä»‹ç»â³" class="headerlink" title="å¾®æœåŠ¡ä»‹ç»â³"></a>å¾®æœåŠ¡ä»‹ç»â³</h1><p><strong>å•ä½“åº”ç”¨æ¶æ„</strong>ï¼šæ—©æœŸäº’è”ç½‘ä¸­ä½¿ç”¨ï¼Œå°†æ‰€æœ‰æ¨¡å—éƒ½éƒ¨ç½²åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Š</p>
<p>é¡¹ç›®ç®€å•ï¼Œå°é¡¹ç›®å¼€å‘æˆæœ¬ä½ï¼Œä½†æ˜¯å¯¹äºå¤§å‹é¡¹ç›®ä¸æ˜“å¼€å‘å’Œç»´æŠ¤</p>
<p><strong>å‚ç›´åº”ç”¨æ¶æ„</strong>ï¼šç³»ç»Ÿæ‹†åˆ†</p>
<p>æµé‡åˆ†æ‹…ï¼Œè§£å†³äº†å¹¶å‘é—®é¢˜ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒæ¨¡å—è¿›è¡Œä¼˜åŒ–å’Œæ°´å¹³æ‰©å±•ï¼Œä¸€ä¸ªç³»ç»Ÿçš„é—®é¢˜ä¸ä¼šå½±å“åˆ°å…¶å®ƒç³»ç»Ÿï¼Œæé«˜å®¹é”™ï¼Œä½†æ˜¯ç³»ç»Ÿä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ— æ³•å‘åè°ƒç”¨ï¼Œä¼šæœ‰é‡å¤çš„å¼€å‘ä»»åŠ¡</p>
<p><strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼šå°†å·¥ç¨‹æ‹†åˆ†æˆè¡¨ç°å±‚å’ŒæœåŠ¡å±‚</p>
<p>æŠ½å–å…¬å…±çš„åŠŸèƒ½ä¸ºæœåŠ¡å±‚ï¼Œæé«˜ä»£ç æœç”¨æ€§ï¼Œç³»ç»Ÿè€¦åˆåº¦å˜é«˜</p>
<p><strong>SOAæ¶æ„</strong>ï¼šåœ¨åˆ†å¸ƒå¼æ¶æ„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ª<code>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</code></p>
<p>ä½¿ç”¨æ³¨å†Œä¸­å¿ƒè§£å†³æœåŠ¡é—´è°ƒç”¨å…³ç³»çš„è‡ªåŠ¨è°ƒèŠ‚ï¼Œä½†æ˜¯é™„ä»¶å³ä¾èµ–ï¼Œä¸€æ—¦æŸä¸ªç¯å¢ƒå‡ºé”™ä¼šå½±å“è¾ƒå¤§ï¼ˆæœåŠ¡é›ªå´©ï¼‰</p>
<p><strong>å¾®æœåŠ¡æ¶æ„</strong>ï¼šæœåŠ¡åŸå­åŒ–æ‹†åˆ†ï¼Œç‹¬ç«‹æ‰“åŒ…ã€éƒ¨ç½²å’Œå‡çº§</p>
<p>åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘æˆæœ¬é«˜</p>
<h1 id="ğŸ“’æœåŠ¡æ²»ç†"><a href="#ğŸ“’æœåŠ¡æ²»ç†" class="headerlink" title="ğŸ“’æœåŠ¡æ²»ç†"></a>ğŸ“’æœåŠ¡æ²»ç†</h1><h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><p>æœåŠ¡æ²»ç†</p>
<blockquote>
<p>å®ç°å„ä¸ªå¾®æœåŠ¡çš„è‡ªåŠ¨åŒ–æ³¨å†Œä¸å‘ç°</p>
</blockquote>
<p>å¸¸è§çš„æ³¨å†Œä¸­å¿ƒæœ‰ <code>Zookeeper</code>ã€<code>Eureka</code>ã€<code>Consul</code>ã€<code>Nacos</code></p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>é¦–å…ˆè¦ä¿è¯ç¯å¢ƒæ­å»ºå®Œæˆï¼Œå¹¶å¯ä»¥æˆåŠŸè®¿é—®</p>
<p><a target="_blank" rel="noopener" href="http://192.168.33.135:8848/nacos">http://192.168.33.135:8848/nacos</a></p>
<h2 id="æ³¨å†ŒæœåŠ¡"><a href="#æ³¨å†ŒæœåŠ¡" class="headerlink" title="æ³¨å†ŒæœåŠ¡"></a>æ³¨å†ŒæœåŠ¡</h2><h3 id="æ³¨å†Œå•†å“å¾®æœåŠ¡"><a href="#æ³¨å†Œå•†å“å¾®æœåŠ¡" class="headerlink" title="æ³¨å†Œå•†å“å¾®æœåŠ¡"></a>æ³¨å†Œå•†å“å¾®æœåŠ¡</h3><blockquote>
<p>module: shop-product</p>
</blockquote>
<p>1.é¦–å…ˆéœ€è¦å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacoså®¢æˆ·ç«¯--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2.å¯åŠ¨ç±»æ·»åŠ  Nacos æ³¨è§£</p>
<blockquote>
<p>ä¸ºäº†å°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.chaoo.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// nacos å‘ç°</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ProductApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.<code>application.yml</code>ä¸­é…ç½® nacos</p>
<blockquote>
<p>å°†å•†å“æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸­</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-comment"># é…ç½® nacos</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br></code></pre></td></tr></table></figure>

<p>4.å¯åŠ¨å•†å“æœåŠ¡</p>
<p>å¯ä»¥å‘ç°æœåŠ¡å·²ç»è¢«æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸­</p>
<h3 id="æ³¨å†Œè®¢å•å¾®æœåŠ¡"><a href="#æ³¨å†Œè®¢å•å¾®æœåŠ¡" class="headerlink" title="æ³¨å†Œè®¢å•å¾®æœåŠ¡"></a>æ³¨å†Œè®¢å•å¾®æœåŠ¡</h3><blockquote>
<p>module: shop-order</p>
</blockquote>
<p>1.å¼•å…¥ä¾èµ–</p>
<p>2.æ·»åŠ æ³¨è§£</p>
<p>3.å†™é…ç½®æ–‡ä»¶</p>
<p>4.å¯åŠ¨è®¢å•å¾®æœåŠ¡</p>
<p>5.æµ‹è¯•å¾®æœè°ƒç”¨</p>
<p>åœ¨ OrderApplication.java å¯åŠ¨ä¸­æ·»åŠ  RestTemplate æ–¹æ³•ï¼Œå¹¶æŠŠè¿™ä¸ªå¯¹è±¡æ”¾åˆ°å®¹å™¨ä¸­ï¼Œä¾¿äºå¾®æœä¹‹é—´çš„è°ƒç”¨</p>
<blockquote>
<p>RestTemplate æ˜¯ Spring æä¾›çš„ç”¨äºè®¿é—® Rest æœåŠ¡çš„å®¢æˆ·ç«¯ï¼ŒRestTemplate æä¾›äº†å¤šç§ä¾¿æ·è®¿é—®è¿œç¨‹ Http æœåŠ¡çš„æ–¹æ³•,èƒ½å¤Ÿå¤§å¤§æé«˜å®¢æˆ·ç«¯çš„ç¼–å†™æ•ˆç‡</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.chaoo.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// æ³¨å†Œ Nacos</span><br><span class="hljs-meta">@EnableFeignClients</span> <span class="hljs-comment">// å¼€å¯Fein</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span> <span class="hljs-comment">// Ribbonå®ç°è´Ÿè½½å‡è¡¡</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>6.æµ‹è¯•è¿œç¨‹è°ƒç”¨</p>
<p>åœ¨ OrderController.java ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/prod/&#123;pid&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> &#123;<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> restTemplate.getForObject(<span class="hljs-string">&quot;http://localhost:8081/product/&quot;</span> + pid, Product.class);<br>        System.out.println(product);<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> Order.builder()<br>                .uid(<span class="hljs-number">1L</span>)<br>                .username(<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>)<br>                .pid(product.getId())<br>                .pname(product.getName())<br>                .price(product.getPrice())<br>                .number(<span class="hljs-number">1</span>)<br>                .build();<br>        orderService.save(order);<br>        <span class="hljs-keyword">return</span> order;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>7.å¯åŠ¨è¿è¡Œ</p>
<p>å¯åŠ¨ shop-product å’Œ shop-order ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <a target="_blank" rel="noopener" href="http://lcoalhost:8091/order/prod/1%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C">http://lcoalhost:8091/order/prod/1ï¼Œå³å¯çœ‹åˆ°æ•ˆæœ</a></p>
<h1 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h1><p>è´Ÿè½½å‡è¡¡å°±æ˜¯å°†è´Ÿè½½ï¼ˆå·¥ä½œä»»åŠ¡ï¼Œè®¿é—®è¯·æ±‚ï¼‰è¿›è¡Œåˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒï¼ˆæœåŠ¡å™¨ç»„ä»¶ï¼‰ä¸Šè¿›è¡Œæ‰§è¡Œ</p>
<p>æ ¹æ®è´Ÿè½½å‡è¡¡å‘ç”Ÿä½ç½®çš„ä¸åŒï¼Œä¸€èˆ¬åˆ†ä¸ºæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚ æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡æä¾›è€…ä¸€æ–¹ï¼Œæ¯”å¦‚å¸¸è§çš„ nginx è´Ÿè½½å‡è¡¡ã€‚è€Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡è¯·æ±‚çš„ä¸€æ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨å‘é€è¯·æ±‚ä¹‹å‰å·²ç»é€‰å¥½äº†ç”±å“ªä¸ªå®ä¾‹å¤„ç†è¯·æ±‚</p>
<p>åœ¨<strong>å¾®æœåŠ¡</strong>è°ƒç”¨å…³ç³»ä¸­ä¸€èˆ¬ä¼šé€‰æ‹©å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯åœ¨æœåŠ¡è°ƒç”¨çš„ä¸€æ–¹æ¥å†³å®šæœåŠ¡ç”±å“ªä¸ªæä¾›è€…æ‰§è¡Œ</p>
<h2 id="è‡ªå®šä¹‰å®ç°è´Ÿè½½å‡è¡¡"><a href="#è‡ªå®šä¹‰å®ç°è´Ÿè½½å‡è¡¡" class="headerlink" title="è‡ªå®šä¹‰å®ç°è´Ÿè½½å‡è¡¡"></a>è‡ªå®šä¹‰å®ç°è´Ÿè½½å‡è¡¡</h2><h3 id="1-é…ç½®ä¸€ä¸ªæ–°çš„æœåŠ¡æä¾›è€…"><a href="#1-é…ç½®ä¸€ä¸ªæ–°çš„æœåŠ¡æä¾›è€…" class="headerlink" title="1.é…ç½®ä¸€ä¸ªæ–°çš„æœåŠ¡æä¾›è€…"></a>1.é…ç½®ä¸€ä¸ªæ–°çš„æœåŠ¡æä¾›è€…</h3><p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208022245839.png" srcset="/img/loading.gif" lazyload alt="image-20220802222833731"></p>
<h4 id="2-ä¿®æ”¹OrderController"><a href="#2-ä¿®æ”¹OrderController" class="headerlink" title="2.ä¿®æ”¹OrderController"></a>2.ä¿®æ”¹OrderController</h4><p>ç”±äºæœ‰ä¸¤ä¸ªæœåŠ¡æä¾›è€…ï¼Œè€Œç°åœ¨ OrderController æ˜¯åªèƒ½è·å–ä¸€ä¸ªæœåŠ¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç </p>
<blockquote>
<p>é€šè¿‡ Random å»éšæœºæŒ‡å®šæœåŠ¡æä¾›è€…</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/prod/&#123;pid&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> &#123;<br>        <span class="hljs-comment">// ä»æœåŠ¡ä¸­å¿ƒè·å–è¯·æ±‚çš„åœ°å€</span><br>        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">&quot;service-</span><br><span class="hljs-string">                product&quot;</span>);<br>        <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªéšæœºæ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(instances.size());<br>        <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> instances.get(index);<br>        <span class="hljs-comment">// è·å–ä¸»æœºåç§°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> instance.getHost();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> instance.getPort();<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> restTemplate.getForObject(<span class="hljs-string">&quot;http://&quot;</span> + host + <span class="hljs-string">&quot;:&quot;</span> + port<br>                + <span class="hljs-string">&quot;/product/&quot;</span> + pid, Product.class);<br>        <span class="hljs-comment">//Product product =</span><br>        restTemplate.getForObject(<span class="hljs-string">&quot;http://localhost:8081/product/&quot;</span> + pid,<br>                Product.class);<br>        System.out.println(product);<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> Order.builder()<br>                .uid(<span class="hljs-number">1L</span>)<br>                .username(<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>)<br>                .pid(product.getId())<br>                .pname(product.getName())<br>                .price(product.getPrice())<br>                .number(<span class="hljs-number">1</span>)<br>                .build();<br>        <span class="hljs-comment">//orderService.save(order);</span><br>        <span class="hljs-keyword">return</span> order;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-å¯åŠ¨æµ‹è¯•"><a href="#3-å¯åŠ¨æµ‹è¯•" class="headerlink" title="3.å¯åŠ¨æµ‹è¯•"></a>3.å¯åŠ¨æµ‹è¯•</h3><p>å¯åŠ¨ shop-order æœåŠ¡ï¼Œå¹¶è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8091/order/prod/2">http://localhost:8091/order/prod/2</a> æ¥æŸ¥çœ‹è´Ÿè½½å‡è¡¡æ•ˆæœ</p>
<h2 id="åŸºäºRibbonå®ç°è´Ÿè½½å‡è¡¡"><a href="#åŸºäºRibbonå®ç°è´Ÿè½½å‡è¡¡" class="headerlink" title="åŸºäºRibbonå®ç°è´Ÿè½½å‡è¡¡"></a>åŸºäºRibbonå®ç°è´Ÿè½½å‡è¡¡</h2><blockquote>
<p>Ribbonæ˜¯ Spring Cloud çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ³¨è§£å°±èƒ½è½»æ¾çš„æå®šè´Ÿè½½å‡è¡¡</p>
</blockquote>
<h3 id="1-å®ç°è´Ÿè½½å‡è¡¡"><a href="#1-å®ç°è´Ÿè½½å‡è¡¡" class="headerlink" title="1.å®ç°è´Ÿè½½å‡è¡¡"></a>1.å®ç°è´Ÿè½½å‡è¡¡</h3><p>1.å¯¼å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2.åœ¨å¯åŠ¨ç±»ä¸­ RestTemplate æ–¹æ³•ä¸Šæ·»åŠ  <code>@LoadBalanced</code> æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.openlab.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// æ³¨å†Œ Nacos</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span> <span class="hljs-comment">// è´Ÿè½½å‡è¡¡æ³¨è§£</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.ä¿®æ”¹æ§åˆ¶ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/prod/&#123;pid&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;service-product&quot;</span>;<br>        <span class="hljs-comment">// ä½¿ç”¨ Ribbon åï¼Œé€šè¿‡æœåŠ¡çš„åç§°æ¥è·å–</span><br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> restTemplate.getForObject(<span class="hljs-string">&quot;http://&quot;</span> + url + <span class="hljs-string">&quot;/product/&quot;</span> + pid, Product.class);<br>        System.out.println(product);<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> Order.builder().uid(<span class="hljs-number">1L</span>)<br>                .username(<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>)<br>                .pid(product.getId())<br>                .pname(product.getName())<br>                .price(product.getPrice())<br>                .number(<span class="hljs-number">1</span>)<br>                .build();<br>        <span class="hljs-comment">//orderService.save(order);</span><br>        <span class="hljs-keyword">return</span> order;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="2-Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#2-Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="2.Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>2.Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</h3><p>Ribbonå†…ç½®äº†å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥,å†…éƒ¨è´Ÿè½½å‡è¡¡çš„é¡¶çº§æ¥å£ä¸º com.netflix.loadbalancer.IRule , å…·ä½“çš„è´Ÿè½½ç­–ç•¥å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208022244198.png" srcset="/img/loading.gif" lazyload alt="image-20220802224410129"></p>
<p>ä¿®æ”¹é…ç½®æ¥è°ƒæ•´Ribbonçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">service-product:</span> <span class="hljs-comment"># è°ƒç”¨çš„æä¾›è€…çš„åç§°</span><br>    <span class="hljs-attr">ribbon:</span><br>        <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br></code></pre></td></tr></table></figure>



<h1 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h1><p>Feign æ˜¯ Spring Cloud æä¾›çš„ä¸€ä¸ªå£°æ˜å¼çš„ä¼ª HTTP å®¢æˆ·ç«¯ï¼Œå®ƒä½¿å¾—è°ƒç”¨è¿œç¨‹æœåŠ¡å°±åƒè°ƒç”¨æœ¬åœ°æœåŠ¡ä¸€æ ·ç®€å•ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯</p>
<p>Nacos å¾ˆå¥½çš„å…¼å®¹äº† Feignï¼ŒFeigné»˜è®¤é›†æˆäº† Ribbonï¼Œæ‰€ä»¥åœ¨ Nacos ä¸‹ä½¿ç”¨ Fegin é»˜è®¤å°±å®ç°äº†è´Ÿè½½å‡è¡¡çš„æ•ˆæœ</p>
<h2 id="ä½¿ç”¨Feign"><a href="#ä½¿ç”¨Feign" class="headerlink" title="ä½¿ç”¨Feign"></a>ä½¿ç”¨Feign</h2><h2 id="1-å¼•å…¥ä¾èµ–"><a href="#1-å¼•å…¥ä¾èµ–" class="headerlink" title="1.å¼•å…¥ä¾èµ–"></a>1.å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--feignç»„ä»¶--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="2-æ·»åŠ æ³¨è§£"><a href="#2-æ·»åŠ æ³¨è§£" class="headerlink" title="2.æ·»åŠ æ³¨è§£"></a>2.æ·»åŠ æ³¨è§£</h2><p>åœ¨ OrderApplication å¯åŠ¨ç±»ä¸Šæ·»åŠ  @EnableFeignClient æ³¨è§£ï¼Œå¼€å¯ Feign çš„æ”¯æŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.openlab.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients</span> <span class="hljs-comment">// å¼€å¯Feign</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="3-åˆ›å»ºè°ƒç”¨æ¥å£"><a href="#3-åˆ›å»ºè°ƒç”¨æ¥å£" class="headerlink" title="3.åˆ›å»ºè°ƒç”¨æ¥å£"></a>3.åˆ›å»ºè°ƒç”¨æ¥å£</h2><p>åœ¨ shop-order å¾®æœåº”ç”¨ä¸­ ProductService æ¥å£ä¸Šä½¿ç”¨ Feign çš„æ³¨è§£ï¼Œæ¥å®ç°è¿œç¨‹æ–¹æ³•è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;service-product&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;pid&#125;&quot;)</span><br>    Product <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>@FeignClient æ³¨è§£ä¸­æŒ‡å®šçš„åç§°æ˜¯å¾®æœæ³¨å†Œä¸­å¿ƒä¸­çš„æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡æä¾›çš„åç§°</li>
<li>æ¥å£ä¸­çš„æ–¹æ³•åç§°å¯ä»¥ä»»æ„ï¼Œä½†æ˜¯å°½é‡å–ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°</li>
<li>åœ¨è¿™ä¸ªæ¥å£ä¸­éœ€è¦æŒ‡å®šè°ƒç”¨çš„æä¾›è€…çš„å“ªä¸ªæ–¹æ³•</li>
<li>@FeignClient æ³¨è§£çš„ value + @GetMapping æ³¨è§£çš„value å€¼å°±ç»„æˆä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚è·¯å¾„</li>
</ol>
<h2 id="4-ä¿®æ”¹æ§åˆ¶å™¨ç±»"><a href="#4-ä¿®æ”¹æ§åˆ¶å™¨ç±»" class="headerlink" title="4.ä¿®æ”¹æ§åˆ¶å™¨ç±»"></a>4.ä¿®æ”¹æ§åˆ¶å™¨ç±»</h2><p>ä¿®æ”¹ shop-order æ¨¡å—çš„ OrderController æ§åˆ¶å™¨ç±»ï¼Œæ³¨å…¥ ProductService æ¥å£ï¼Œå¹¶è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductService productService;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/prod/&#123;pid&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> &#123;<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productService.getById(pid);<br>        <br>        <span class="hljs-comment">//......çœç•¥</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-å¯åŠ¨æµ‹è¯•"><a href="#5-å¯åŠ¨æµ‹è¯•" class="headerlink" title="5.å¯åŠ¨æµ‹è¯•"></a>5.å¯åŠ¨æµ‹è¯•</h2><p>é‡å¯orderå¾®æœåŠ¡æŸ¥çœ‹æ•ˆæœ</p>
<h1 id="ğŸ“’æœåŠ¡å®¹é”™"><a href="#ğŸ“’æœåŠ¡å®¹é”™" class="headerlink" title="ğŸ“’æœåŠ¡å®¹é”™"></a>ğŸ“’æœåŠ¡å®¹é”™</h1><h2 id="é«˜å¹¶å‘å¸¦æ¥çš„é—®é¢˜"><a href="#é«˜å¹¶å‘å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="é«˜å¹¶å‘å¸¦æ¥çš„é—®é¢˜"></a>é«˜å¹¶å‘å¸¦æ¥çš„é—®é¢˜</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæˆ‘ä»¬å°†ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªçš„æœåŠ¡ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´å¯ä»¥ç›¸äº’è°ƒç”¨ï¼Œä½†æ˜¯ç”±äºç½‘ç»œåŸå› æˆ–è€…è‡ªèº«çš„åŸå› ï¼ŒæœåŠ¡å¹¶ä¸èƒ½ä¿è¯æœåŠ¡çš„ 100% å¯ç”¨ï¼Œå¦‚æœå•ä¸ªæœåŠ¡å‡ºç°é—®é¢˜ï¼Œè°ƒç”¨è¿™ä¸ªæœåŠ¡å°±ä¼šå‡ºç°ç½‘ç»œå»¶è¿Ÿï¼Œæ­¤æ—¶è‹¥æœ‰å¤§é‡çš„ç½‘ç»œæ¶Œå…¥ï¼Œä¼šå½¢æˆä»»åŠ¡å †ç§¯ï¼Œæœ€ç»ˆå¯¼è‡´æœåŠ¡ç˜«ç—ª</p>
<h2 id="æœåŠ¡é›ªå´©æ•ˆåº”"><a href="#æœåŠ¡é›ªå´©æ•ˆåº”" class="headerlink" title="æœåŠ¡é›ªå´©æ•ˆåº”"></a>æœåŠ¡é›ªå´©æ•ˆåº”</h2><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºç½‘ç»œåŸå› æˆ–è‡ªèº«çš„åŸå› ï¼ŒæœåŠ¡ä¸€èˆ¬æ— æ³•ä¿è¯ 100% å¯ç”¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œè°ƒç”¨è¿™ä¸ªæœåŠ¡å°±ä¼šå‡ºç°çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œæ­¤æ—¶è‹¥æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ï¼Œå°±ä¼šå‡ºç°å¤šæ¡çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡ç˜«ç—ª</p>
<p>ç”±äºæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œæ•…éšœä¼šä¼ æ’­ï¼Œä¼šå¯¹æ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿé€ æˆç¾éš¾æ€§çš„ä¸¥é‡åæœï¼Œè¿™å°±æ˜¯æœåŠ¡æ•…éšœçš„ â€œé›ªå´©æ•ˆåº”â€</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208031553988.png" srcset="/img/loading.gif" lazyload alt="image-20220803155304904"  />



<p>é›ªå´©å‘ç”Ÿçš„åŸå› å¤šç§å¤šæ ·ï¼Œæœ‰ä¸åˆç†çš„å®¹é‡è®¾è®¡ï¼Œæˆ–è€…æ˜¯é«˜å¹¶å‘ä¸‹æŸä¸€ä¸ªæ–¹æ³•å“åº”å˜æ…¢ï¼Œäº¦æˆ–æ˜¯æŸå°æœºå™¨çš„èµ„æºè€—å°½ã€‚æˆ‘ä»¬æ— æ³•å®Œå…¨æœç»é›ªå´©æºå¤´çš„å‘ç”Ÿï¼Œåªæœ‰åšå¥½è¶³å¤Ÿçš„å®¹é”™ï¼Œä¿è¯åœ¨ä¸€ä¸ªæœåŠ¡å‘ç”Ÿé—®é¢˜ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚ä¹Ÿå°±æ˜¯ â€œé›ªè½è€Œä¸é›ªå´©â€</p>
<h2 id="å¸¸è§çš„å®¹é”™æ€è·¯"><a href="#å¸¸è§çš„å®¹é”™æ€è·¯" class="headerlink" title="å¸¸è§çš„å®¹é”™æ€è·¯"></a>å¸¸è§çš„å®¹é”™æ€è·¯</h2><p>å¸¸è§çš„å®¹é”™æ€è·¯æœ‰éš”ç¦»ã€è¶…æ—¶ã€é™æµã€ç†”æ–­ã€é™çº§è¿™å‡ ç§</p>
<h3 id="1-éš”ç¦»"><a href="#1-éš”ç¦»" class="headerlink" title="1.éš”ç¦»"></a>1.éš”ç¦»</h3><p>å®ƒæ˜¯æŒ‡å°†ç³»ç»ŸæŒ‰ç…§ä¸€å®šçš„åŸåˆ™åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæœåŠ¡æ¨¡å—ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œæ— å¼ºä¾èµ–ã€‚å½“æœ‰æ•…éšœå‘ç”Ÿæ—¶ï¼Œèƒ½å°†é—®é¢˜å’Œå½±å“éš”ç¦»åœ¨æŸä¸ªæ¨¡å—å†…éƒ¨ï¼Œè€Œä¸æ‰©æ•£é£é™©ï¼Œä¸æ³¢åŠå…¶å®ƒæ¨¡å—ï¼Œä¸å½±å“æ•´ä½“çš„ç³»ç»ŸæœåŠ¡ã€‚å¸¸è§çš„éš”ç¦»æ–¹å¼æœ‰ï¼šçº¿ç¨‹æ± éš”ç¦»å’Œä¿¡å·é‡éš”ç¦»</p>
<h3 id="2-è¶…æ—¶"><a href="#2-è¶…æ—¶" class="headerlink" title="2.è¶…æ—¶"></a>2.è¶…æ—¶</h3><p>åœ¨ä¸Šæ¸¸æœåŠ¡è°ƒç”¨ä¸‹æ¸¸æœåŠ¡çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªæœ€å¤§å“åº”æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œä¸‹æ¸¸æœªä½œå‡ºååº”ï¼Œ å°±æ–­å¼€è¯·æ±‚ï¼Œé‡Šæ”¾æ‰çº¿ç¨‹</p>
<h3 id="3-é™æµ"><a href="#3-é™æµ" class="headerlink" title="3.é™æµ"></a>3.é™æµ</h3><p>é™æµå°±æ˜¯é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡å·²è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å›ºè¿è¡Œï¼Œä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼,å°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–å°‘é‡æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„</p>
<h3 id="4-ç†”æ–­"><a href="#4-ç†”æ–­" class="headerlink" title="4.ç†”æ–­"></a>4.ç†”æ–­</h3><p>åœ¨äº’è”ç½‘ç³»ç»Ÿä¸­ï¼Œå½“ä¸‹æ¸¸æœåŠ¡å› è®¿é—®å‹åŠ›è¿‡å¤§è€Œå“åº”å˜æ…¢æˆ–å¤±è´¥ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿæ•´ä½“çš„å¯ç”¨æ€§ï¼Œå¯ä»¥æš‚æ—¶åˆ‡æ–­å¯¹ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨ã€‚è¿™ç§ç‰ºç‰²å±€éƒ¨ï¼Œä¿å…¨æ•´ä½“çš„æªæ–½å°±å«åšç†”æ–­ã€‚</p>
<p>æœåŠ¡ç†”æ–­ä¸€èˆ¬æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p>
<ul>
<li>ç†”æ–­å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰<ul>
<li>æœåŠ¡æ²¡æœ‰æ•…éšœæ—¶ï¼Œç†”æ–­å™¨æ‰€å¤„çš„çŠ¶æ€ï¼Œå¯¹è°ƒç”¨æ–¹çš„è°ƒç”¨ä¸åšä»»ä½•é™åˆ¶</li>
</ul>
</li>
<li>ç†”æ–­å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰<ul>
<li>åç»­å¯¹è¯¥æœåŠ¡æ¥å£çš„è°ƒç”¨ä¸å†ç»è¿‡ç½‘ç»œï¼Œç›´æ¥æ‰§è¡Œæœ¬åœ°çš„fallbackæ–¹æ³•</li>
</ul>
</li>
<li>åŠç†”æ–­çŠ¶æ€ï¼ˆHalf-Openï¼‰<ul>
<li>å°è¯•æ¢å¤æœåŠ¡è°ƒç”¨ï¼Œå…è®¸æœ‰é™çš„æµé‡è°ƒç”¨è¯¥æœåŠ¡ï¼Œå¹¶ç›‘æ§è°ƒç”¨æˆåŠŸç‡ã€‚å¦‚æœæˆåŠŸç‡è¾¾åˆ°é¢„æœŸï¼Œåˆ™è¯´æ˜æœåŠ¡å·²æ¢å¤ï¼Œè¿›å…¥ç†”æ–­å…³é—­çŠ¶æ€ï¼›å¦‚æœæˆåŠŸç‡ä»æ—§å¾ˆä½ï¼Œåˆ™é‡æ–°è¿›å…¥ç†”æ–­å…³é—­çŠ¶æ€</li>
</ul>
</li>
</ul>
<h3 id="5-é™çº§"><a href="#5-é™çº§" class="headerlink" title="5.é™çº§"></a>5.é™çº§</h3><p>é™çº§å…¶å®å°±æ˜¯ä¸ºæœåŠ¡æä¾›ä¸€ä¸ªæ‰˜åº•æ–¹æ¡ˆï¼Œä¸€æ—¦æœåŠ¡æ— æ³•æ­£å¸¸è°ƒç”¨ï¼Œå°±ä½¿ç”¨æ‰˜åº•æ–¹æ¡ˆ</p>
<blockquote>
<p>ä¾‹å¦‚ï¼šæ˜¾ç¤ºç½‘ç»œå¼‚å¸¸</p>
</blockquote>
<h2 id="å¸¸è§çš„å®¹é”™ç»„ä»¶"><a href="#å¸¸è§çš„å®¹é”™ç»„ä»¶" class="headerlink" title="å¸¸è§çš„å®¹é”™ç»„ä»¶"></a>å¸¸è§çš„å®¹é”™ç»„ä»¶</h2><p><strong>Hystrix</strong><br>Hystrixæ˜¯ç”±Netflixå¼€æºçš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è®¿é—®è¿œç¨‹ç³»ç»Ÿã€æœåŠ¡æˆ–è€…ç¬¬ä¸‰æ–¹åº“ï¼Œé˜²æ­¢çº§è”å¤±è´¥ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ä¸å®¹é”™æ€§ã€‚</p>
<p><strong>Resilience4J</strong><br>Resilicence4Jä¸€æ¬¾éå¸¸è½»é‡ã€ç®€å•ï¼Œå¹¶ä¸”æ–‡æ¡£éå¸¸æ¸…æ™°ã€ä¸°å¯Œçš„ç†”æ–­å·¥å…·ï¼Œè¿™ä¹Ÿæ˜¯Hystrixå®˜æ–¹æ¨èçš„æ›¿ä»£äº§å“ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒResilicence4jè¿˜åŸç”Ÿæ”¯æŒSpring Boot 1.x&#x2F;2.xï¼Œè€Œä¸”ç›‘æ§ä¹Ÿæ”¯æŒå’Œ prometheusç­‰å¤šæ¬¾ä¸»æµäº§å“è¿›è¡Œæ•´åˆã€‚</p>
<p><strong>Sentinel</strong><br>Sentinel æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾æ–­è·¯å™¨å®ç°ï¼Œæœ¬èº«åœ¨é˜¿é‡Œå†…éƒ¨å·²ç»è¢«å¤§è§„æ¨¡é‡‡ç”¨ï¼Œéå¸¸ç¨³å®šã€‚</p>
<h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><p><strong>èµ„æº</strong>ï¼šèµ„æºæ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚å®ƒå…¶å®å°±æ˜¯ Sentinal è¦ä¿æŠ¤çš„å†…å®¹</p>
<p><strong>è§„åˆ™</strong>ï¼šä½œç”¨åœ¨èµ„æºä¹‹ä¸Š, å®šä¹‰ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼ä¿æŠ¤èµ„æºï¼Œä¸»è¦åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚å…¶å®è§„åˆ™å°±æ˜¯ç”¨æ¥å®šä¹‰å¦‚ä½•è¿›è¡Œä¿æŠ¤èµ„æº</p>
<blockquote>
<p>åƒæ¡ˆä¾‹ä¸­çš„ message1 æ–¹æ³•å°±æ˜¯èµ„æºï¼Œç„¶åå¯¹æ­¤èµ„æºè¿›è¡Œä¿æŠ¤çš„å°±æ˜¯è§„åˆ™</p>
</blockquote>
<p>Sentinel çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å®¹é”™</p>
<p>ä¸»è¦ä½“ç°åœ¨ä¸‹é¢ä¸‰ç‚¹ï¼š</p>
<ol>
<li>æµé‡æ§åˆ¶</li>
<li>ç†”æ–­é™çº§</li>
<li>ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤</li>
</ol>
<p>æœ€ç»ˆç›®çš„å°±æ˜¯åœ¨ Sentinel ä¸Šé…ç½®å„ç§å„æ ·çš„è§„åˆ™ï¼Œå»å®ç°å„ç§å„æ ·çš„å®¹é”™åŠŸèƒ½</p>
<h2 id="æµæ§è§„åˆ™"><a href="#æµæ§è§„åˆ™" class="headerlink" title="æµæ§è§„åˆ™"></a>æµæ§è§„åˆ™</h2><p><strong>èµ„æºå</strong>ï¼šå”¯ä¸€åç§°ï¼Œé»˜è®¤æ˜¯è¯·æ±‚è·¯å¾„ï¼Œå¯è‡ªå®šä¹‰</p>
<p><strong>é’ˆå¯¹æ¥æº</strong>ï¼šæŒ‡å®šå¯¹å“ªä¸ªå¾®æœåŠ¡è¿›è¡Œé™æµï¼Œé»˜è®¤æŒ‡defaultï¼Œæ„æ€æ˜¯ä¸åŒºåˆ†æ¥æºï¼Œå…¨éƒ¨é™åˆ¶</p>
<p><strong>é˜ˆå€¼ç±»å‹&#x2F;å•æœºé˜ˆå€¼</strong>ï¼šQPSï¼ˆæ¯ç§’è¯·æ±‚æ•°é‡ï¼‰: å½“è°ƒç”¨è¯¥æ¥å£çš„QPSè¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµ</p>
<p><strong>çº¿ç¨‹æ•°</strong>ï¼šå½“è°ƒç”¨è¯¥æ¥å£çš„çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ï¼Œè¿›è¡Œé™æµ</p>
<p><strong>æ˜¯å¦é›†ç¾¤</strong>ï¼šæš‚ä¸éœ€è¦é›†ç¾¤</p>
<p>Sentinel æµæ§æ¨¡å¼</p>
<ul>
<li>ç›´æ¥ï¼ˆé»˜è®¤ï¼‰ï¼šæ¥å£è¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµã€‚å³åªå¯¹æŒ‡å®šçš„æ¥å£è¿›è¡Œæµæ§ã€‚</li>
<li>å…³è”ï¼šå½“å…³è”çš„èµ„æºè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµ [é€‚åˆåšåº”ç”¨è®©æ­¥ï¼Œä¹Ÿå°±æ˜¯å…³è”çš„èµ„æºä¼˜å…ˆ]</li>
<li>é“¾è·¯ï¼šå½“ä»æŸä¸ªæ¥å£è¿‡æ¥çš„èµ„æºè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµ</li>
</ul>
<h3 id="ç›´æ¥æµæ§"><a href="#ç›´æ¥æµæ§" class="headerlink" title="ç›´æ¥æµæ§"></a>ç›´æ¥æµæ§</h3><blockquote>
<p>é™åˆ¶QPSä¸º2ï¼Œå³æ¯ç§’æœ€å¤šä¸¤æ¬¡</p>
</blockquote>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041129124.png" srcset="/img/loading.gif" lazyload alt="image-20220804112909021" style="zoom: 67%;" />

<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºæ¥æˆ‘ä»¬åªæ˜¯å»é…ç½®äº†å•æœºé˜ˆå€¼ä¸º2ï¼Œå¹¶æ²¡æœ‰å»åšå…¶å®ƒæ”¹å˜ï¼Œå› ä¸º Sentinel çš„é»˜è®¤æµæ§æ–¹å¼å°±æ˜¯ç›´æ¥æµæ§</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥å»æµ‹è¯•ä¸€ä¸‹<strong>å¹¶å‘çº¿ç¨‹æ•°</strong></p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041135753.png" srcset="/img/loading.gif" lazyload alt="image-20220804113514679" style="zoom:50%;" />

<p>åªä¸è¿‡è¿™æ ·å°±éœ€è¦å»ä½¿ç”¨ Jmeter å»æµ‹è¯•</p>
<blockquote>
<p>Jemter:</p>
<p>é¦–å…ˆæ·»åŠ ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œè®¾ç½®å¥½çº¿ç¨‹æ•°ä¸º 2ï¼Œå¹¶é€‰æ‹©å¾ªç¯æ¬¡æ•°ä¸ºæ°¸è¿œ<br>ç„¶åå†æ·»åŠ å–æ ·å™¨ä¸­çš„ HTTP è¯·æ±‚ï¼Œè®¾ç½®å¥½åè®®ä¸º httpï¼ŒæœåŠ¡å™¨åç§°æˆ–IP ä¸ºlocalhostï¼Œç«¯å£å·ä¸º8091ï¼Œè·¯å¾„è®¾ç½®ä¸º &#x2F;order&#x2F;message1ï¼Œæ–¹æ³•è®¾ç½®ä¸º GETã€‚è¿™æ ·å°±å¯ä»¥ç‚¹å‡»å¯åŠ¨äº†</p>
</blockquote>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136596.png" srcset="/img/loading.gif" lazyload alt="image-20220804113622521" style="zoom: 67%;" />

<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136886.png" srcset="/img/loading.gif" lazyload alt="image-20220804113636835"></p>
<h3 id="å…³è”æµæ§"><a href="#å…³è”æµæ§" class="headerlink" title="å…³è”æµæ§"></a>å…³è”æµæ§</h3><p>è®©æˆ‘ä»¬çš„ message1æ¥å£ å»å…³è” message2æ¥å£ï¼Œå½“ message2 æ¥å£è¾¾åˆ°ä¸€å®šé˜ˆå€¼æ¡ä»¶æ—¶ï¼Œå°±ä¼šå¯¹ message1 æ¥å£è¿›è¡Œé™æµ</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041140341.png" srcset="/img/loading.gif" lazyload alt="image-20220804114029282" style="zoom:67%;" />

<p>è®¾ç½®å®Œæˆåï¼Œä½¿ç”¨ Jmeter å‘&#x2F;order&#x2F;message2è¿ç»­å‘é€è¯·æ±‚ï¼Œæ³¨æ„QPSä¸€å®šè¦å¤§äº3</p>
<p>Jmeter çº¿ç¨‹ç»„é…ç½®</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041141298.png" srcset="/img/loading.gif" lazyload alt="image-20220804114108227"></p>
<p>Jmeter è¯·æ±‚é…ç½®</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041141439.png" srcset="/img/loading.gif" lazyload alt="image-20220804114141362"></p>
<p>å¯åŠ¨ Jmeter åï¼Œæˆ‘ä»¬ä¼šå‘ç°è®¿é—®ä¸äº† message1 æ¥å£</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041136886.png" srcset="/img/loading.gif" lazyload alt="image-20220804113636835"></p>
<h3 id="é“¾è·¯æµæ§"><a href="#é“¾è·¯æµæ§" class="headerlink" title="é“¾è·¯æµæ§"></a>é“¾è·¯æµæ§</h3><p>é“¾è·¯æµæ§æ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå½“ä»æŸä¸ªæ¥å£è¿‡æ¥çš„èµ„æºè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµã€‚å®ƒçš„åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼äºé’ˆå¯¹æ¥æºé…ç½®é¡¹ï¼ŒåŒºåˆ«åœ¨äºï¼š<strong>é’ˆå¯¹æ¥æºæ˜¯é’ˆå¯¹ä¸Šçº§å¾®æœåŠ¡ï¼Œè€Œé“¾è·¯æµæ§æ˜¯é’ˆå¯¹ä¸Šçº§æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„ç²’åº¦æ›´ç»†</strong></p>
<p>ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ª Controller æ§åˆ¶å™¨ç±»ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³• message1 å’Œ message2ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨ Service ä¸­çš„ message æ–¹æ³•ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é’ˆå¯¹è¿™ä¸¤ä¸ªé“¾è·¯è¿›è¡Œé™æµäº†ã€‚æˆ‘ä»¬æŠŠ Serviceä¸­çš„ message æ–¹æ³•å½“åšæ˜¯èµ„æºï¼Œåœ¨å®ƒä¸Šé¢è®¾ç½®è§„åˆ™ï¼šå½“ message1 è¯·æ±‚çš„ QPS è¾¾åˆ° 3 æ—¶é™æµ</p>
<p>ç¬¬1æ­¥ï¼š ç¼–å†™ä¸€ä¸ªserviceï¼Œåœ¨é‡Œé¢æ·»åŠ ä¸€ä¸ªæ–¹æ³•message</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl2</span> &#123;<br>    <span class="hljs-comment">// é€šè¿‡ @SentinelResource æ³¨è§£çš„ value å±æ€§æ¥æŒ‡å®šèµ„æºçš„åç§°</span><br>    <span class="hljs-meta">@SentinelResource(&quot;message&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">message</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;message&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¬¬2æ­¥ï¼š åœ¨Controllerä¸­å£°æ˜ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«è°ƒç”¨serviceä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-comment">//...çœç•¥</span><br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderServiceImpl2 orderServiceImpl2;<br>    <br>    <span class="hljs-comment">//......çœç•¥</span><br>    <br>    <span class="hljs-comment">// ç”¨äºæµ‹è¯•é«˜å¹¶å‘çš„æ–¹æ³•</span><br>    <span class="hljs-meta">@GetMapping(&quot;/message&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message&quot;</span>;<br>        &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/message1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message1</span><span class="hljs-params">()</span> &#123;<br>    orderServiceImpl2.message();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/message2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message2</span><span class="hljs-params">()</span> &#123;<br>        orderServiceImpl2.message();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041146409.png" srcset="/img/loading.gif" lazyload alt="image-20220804114628298" style="zoom: 50%;" />

<blockquote>
<p>æ„Ÿè§‰é“¾è·¯å’Œå…³è”åœ¨æŸäº›æ–¹å‘ä¸Šæ˜¯ç›¸ä¼¼çš„</p>
<p>ä½†æ˜¯ä¸åŒåœ¨äºé“¾è·¯ä¸­ï¼Œ å…¥å£èµ„æºæ˜¯éœ€è¦å»è°ƒç”¨èµ„æºçš„ï¼Œå½“å…¥å£èµ„æºè®¿é—®QPSè¾¾åˆ°ä¸€å®šç¨‹åº¦ï¼Œæˆ‘ä»¬ä¼šå¯¹æ­¤èµ„æºå®è¡Œé™åˆ¶</p>
<p>è€Œå…³è”åˆ™æ˜¯é€šè¿‡å¦ä¸€ä¸ªèµ„æº message2 å»å½±å“ message1</p>
</blockquote>
<h2 id="é™çº§è§„åˆ™"><a href="#é™çº§è§„åˆ™" class="headerlink" title="é™çº§è§„åˆ™"></a>é™çº§è§„åˆ™</h2><p>RT: <code>Round Trip Time</code>,å“åº”æ—¶é—´</p>
<h3 id="å¹³å‡å“åº”æ—¶é—´"><a href="#å¹³å‡å“åº”æ—¶é—´" class="headerlink" title="å¹³å‡å“åº”æ—¶é—´"></a>å¹³å‡å“åº”æ—¶é—´</h3><p>åœ¨ Sentinel æµæ§è§„åˆ™ä¸­æ‰¾åˆ° &#x2F;order&#x2F;message1 ï¼Œç„¶åç‚¹å‡»â€œç†”æ–­â€æŒ‰é’®ï¼Œæ‰“å¼€ç†”æ–­è§„åˆ™é…ç½®é¢ç‰ˆï¼Œå¹¶è¿›è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„è§„åˆ™é…ç½®</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041156234.png" srcset="/img/loading.gif" lazyload alt="image-20220804115614118" style="zoom: 50%;" />

<p>ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯ï¼šå½“èµ„æºçš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼ˆä»¥ ms ä¸ºå•ä½ï¼‰ä¹‹åï¼Œèµ„æºè¿›å…¥å‡†é™çº§çŠ¶æ€ã€‚å¦‚æœæ¥ä¸‹æ¥ 1s å†…æŒç»­è¿›å…¥ 5 ä¸ªè¯·æ±‚ï¼Œå®ƒä»¬çš„ RT (Round Trip Time,å“åº”æ—¶é—´)éƒ½æŒç»­è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå°±ä¼šå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡ŒæœåŠ¡é™çº§</p>
<h3 id="å¼‚å¸¸æ¯”ä¾‹"><a href="#å¼‚å¸¸æ¯”ä¾‹" class="headerlink" title="å¼‚å¸¸æ¯”ä¾‹"></a>å¼‚å¸¸æ¯”ä¾‹</h3><p>å½“èµ„æºçš„æ¯ç§’å¼‚å¸¸æ€»æ•°å é€šè¿‡é‡çš„æ¯”å€¼è¶…è¿‡é˜ˆå€¼ä¹‹åï¼Œèµ„æºè¿›å…¥é™çº§çŠ¶æ€ï¼Œå³åœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨åœ°è¿”å›ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ [0.0, 1.0]</p>
<p>ç¬¬1æ­¥: é¦–å…ˆæ¨¡æ‹Ÿä¸€ä¸ªå¼‚å¸¸ã€‚é¦–å…ˆè®¾ç½®äº†ä¸€ä¸ªå…¨å±€å˜é‡ iï¼Œæ¯æ¬¡è®¿é—®è¿™ä¸ªå€¼åŠ  1ï¼Œå¹¶åœ¨ message1 æ–¹æ³•ä¸­æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-meta">@GetMapping(&quot;/message1&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// orderServiceImpl2.message(20);</span><br>    i++;<br>    <span class="hljs-keyword">if</span> (i % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¬¬2æ­¥: è®¾ç½®å¼‚å¸¸æ¯”ä¾‹ä¸º0.25</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041158739.png" srcset="/img/loading.gif" lazyload alt="image-20220804115812637" style="zoom:50%;" />

<p>è®¾ç½®å¥½åä¿å­˜ï¼Œç„¶åé¢‘ç¹è®¿é—® message1ï¼Œå°±å¯ä»¥çœ‹åˆ°è¢«é™ä½äº†ï¼Œé™ä½çš„ç»´æŒæ—¶é—´ä¸º 5 ç§’é’Ÿ</p>
<h3 id="å¼‚å¸¸æ•°"><a href="#å¼‚å¸¸æ•°" class="headerlink" title="å¼‚å¸¸æ•°"></a>å¼‚å¸¸æ•°</h3><p>å½“èµ„æºè¿‘ 1 åˆ†é’Ÿçš„å¼‚å¸¸æ•°ç›®è¶…è¿‡é˜ˆå€¼ä¹‹åä¼šè¿›è¡ŒæœåŠ¡é™çº§ã€‚æ³¨æ„ç”±äºç»Ÿè®¡æ—¶é—´çª—å£æ˜¯ç§’é’Ÿçº§åˆ«çš„ï¼Œè‹¥æ—¶é—´çª—å£å°äº 60sï¼Œåˆ™ç»“æŸç†”æ–­çŠ¶æ€åä»å¯èƒ½å†è¿›å…¥ç†”æ–­çŠ¶æ€</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041154864.png" srcset="/img/loading.gif" lazyload alt="image-20220804115408774"></p>
<h2 id="çƒ­ç‚¹è§„åˆ™"><a href="#çƒ­ç‚¹è§„åˆ™" class="headerlink" title="çƒ­ç‚¹è§„åˆ™"></a>çƒ­ç‚¹è§„åˆ™</h2><p>çƒ­ç‚¹å‚æ•°æµæ§è§„åˆ™æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„æµæ§è§„åˆ™ï¼Œå®ƒå…è®¸å°†è§„åˆ™å…·ä½“åˆ°å‚æ•°ä¸Š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/message3&quot;)</span><br><span class="hljs-meta">@SentinelResource(&quot;message3&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message3</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;name&quot;, defaultValue = &quot;&quot;)</span> String name,</span><br><span class="hljs-params">                       <span class="hljs-meta">@RequestParam(value = &quot;age&quot;, defaultValue = &quot;0&quot;)</span> Integer age)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message3 &quot;</span> + name + <span class="hljs-string">&quot; &quot;</span> + age;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šè¦æƒ³çƒ­ç‚¹è§„åˆ™ç”Ÿæ•ˆï¼Œå¿…é¡»åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @SentinelResource æ³¨è§£ï¼Œå¹¶é€šè¿‡è¿™ä¸ªæ³¨è§£æ¥æŒ‡å®šèµ„æºçš„åç§°ï¼Œç„¶ååœ¨è¿™ä¸ªèµ„æºåç§°ä¸Šè¿›è¡Œçƒ­ç‚¹è§„åˆ™çš„æŒ‡å®šï¼Œè¿™æ ·æ‰ä¼šæœ‰æµæ§çš„æ•ˆæœ</p>
<blockquote>
<p>åœ¨é…ç½®nameçš„çƒ­ç‚¹è§„åˆ™ï¼Œä¸ç”Ÿæ•ˆ</p>
</blockquote>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041200021.png" srcset="/img/loading.gif" lazyload alt="image-20220804120049902" style="zoom:50%;" />

<p>ä¸Šé¢çš„é…ç½®è¡¨ç¤ºé™¤äº† age çš„å€¼ä¸º 18 ä»¥å¤–ï¼Œå…¶å®ƒçš„å€¼éƒ½ä¼šè¢«æµæ§</p>
<h2 id="æˆæƒè§„åˆ™"><a href="#æˆæƒè§„åˆ™" class="headerlink" title="æˆæƒè§„åˆ™"></a>æˆæƒè§„åˆ™</h2><p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è°ƒç”¨æ¥æºæ¥åˆ¤æ–­è¯¥æ¬¡è¯·æ±‚æ˜¯å¦å…è®¸æ”¾è¡Œï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ Sentinel çš„æ¥æºè®¿é—®æ§åˆ¶çš„åŠŸèƒ½ã€‚æ¥æºè®¿é—®æ§åˆ¶æ ¹æ®èµ„æºçš„è¯·æ±‚æ¥æºï¼ˆoriginï¼‰é™åˆ¶èµ„æºæ˜¯å¦é€šè¿‡ï¼š</p>
<ul>
<li>è‹¥é…ç½®ç™½åå•ï¼Œåˆ™åªæœ‰è¯·æ±‚æ¥æºä½äºç™½åå•å†…æ—¶æ‰å¯é€šè¿‡ï¼›</li>
<li>è‹¥é…ç½®é»‘åå•ï¼Œåˆ™è¯·æ±‚æ¥æºä½äºé»‘åå•æ—¶ä¸é€šè¿‡ï¼Œå…¶ä½™çš„è¯·æ±‚é€šè¿‡</li>
</ul>
<h2 id="ç³»ç»Ÿè§„åˆ™"><a href="#ç³»ç»Ÿè§„åˆ™" class="headerlink" title="ç³»ç»Ÿè§„åˆ™"></a>ç³»ç»Ÿè§„åˆ™</h2><p>ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯ä»åº”ç”¨çº§åˆ«çš„å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»å•å°æœºå™¨çš„æ€»ä½“ Loadï¼ˆè´Ÿè½½ï¼‰ã€RTï¼ˆå¹³å‡å“åº”æ—¶é—´ï¼‰ã€å…¥å£ QPS ã€CPU ä½¿ç”¨ç‡å’Œçº¿ç¨‹æ•°äº”ä¸ªç»´åº¦ç›‘æ§åº”ç”¨æ•°æ®ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§</p>
<p>ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯åº”ç”¨æ•´ä½“ç»´åº¦çš„ï¼Œè€Œä¸æ˜¯èµ„æºç»´åº¦çš„ï¼Œå¹¶ä¸”ä»…å¯¹å…¥å£æµé‡ (è¿›å…¥åº”ç”¨çš„æµé‡) ç”Ÿæ•ˆã€‚</p>
<ul>
<li>Loadï¼ˆä»…å¯¹ Linux&#x2F;Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰ï¼šå½“ç³»ç»Ÿ load1ï¼ˆåœ¨Linuxä¸­åŒ…å«load1~load15ï¼Œè¡¨ç¤º1åˆ†é’Ÿåˆ°15åˆ†é’Ÿï¼‰è¶…è¿‡é˜ˆå€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ maxQps * minRt è®¡ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ CPU cores * 2.5ã€‚</li>
<li>RTï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
<li>çº¿ç¨‹æ•°ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
<li>å…¥å£ QPSï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
<li>CPUä½¿ç”¨ç‡ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ CPUä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
</ul>
<h2 id="è‡ªå®šä¹‰å¼‚å¸¸è¿”å›"><a href="#è‡ªå®šä¹‰å¼‚å¸¸è¿”å›" class="headerlink" title="è‡ªå®šä¹‰å¼‚å¸¸è¿”å›"></a>è‡ªå®šä¹‰å¼‚å¸¸è¿”å›</h2><p>åœ¨å‰é¢çš„è§„åˆ™ä¸­ï¼Œå¦‚æœè¢«é™æµäº†ï¼Œä¼šæ˜¾ç¤ºä¸€ä¸ªå¼‚å¸¸é¡µé¢ã€‚å½“æœ‰å¤šä¸ªè§„åˆ™åŒæ—¶èµ·ä½œç”¨æ—¶ï¼Œè¿™ä¸ªå¼‚å¸¸é¡µé¢å°±ä¸çŸ¥é“æ˜¯é‚£ä¸ªè§„åˆ™è¿”å›çš„é¡µé¢ï¼Œä¸ä¾¿äºç¨‹åºç»´æŠ¤ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSentinel æ”¯æŒè‡ªå®šä¹‰å¼‚å¸¸è¿”å›</p>
<p>åœ¨ shop-order å¾®æœä¸­çš„ config åŒ…ä¸‹ï¼Œæ–°å¢ ExceptionHandlerPage ç±»ï¼Œå¹¶å®ç° BlockExceptionHandler æ¥å£ï¼Œç„¶åé‡å†™ handle æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é¡µ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionHandlerPage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockExceptionHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse response, BlockException ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> FlowException) &#123;<br>            msg = <span class="hljs-string">&quot;é™æµäº†&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> DegradeException) &#123;<br>            msg = <span class="hljs-string">&quot;é™çº§äº†&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> ParamFlowException) &#123;<br>            msg = <span class="hljs-string">&quot;çƒ­ç‚¹å‚æ•°é™æµ&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> SystemBlockException) &#123;<br>            msg = <span class="hljs-string">&quot;ç³»ç»Ÿè§„åˆ™(è´Ÿè½½/...ä¸æ»¡è¶³è¦æ±‚)&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> AuthorityException) &#123;<br>            msg = <span class="hljs-string">&quot;æˆæƒè§„åˆ™ä¸é€šè¿‡&quot;</span>;<br>        &#125;<br><br>        response.setStatus(<span class="hljs-number">500</span>);<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        response.setHeader(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br><br>        response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(msg));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>CTRL + ALT + B</code></p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041449241.png" srcset="/img/loading.gif" lazyload alt="image-20220804144908155" style="zoom:67%;" />

<p>é‡å¯æœåŠ¡åï¼Œè®¾ç½®æµæ§ï¼Œå†æ¬¡è®¿é—®å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ•ˆæœ</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041449733.png" srcset="/img/loading.gif" lazyload alt="image-20220804144939679" style="zoom:67%;" />

<h2 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h2><p>åœ¨å®šä¹‰äº†èµ„æºç‚¹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Dashboardæ¥è®¾ç½®é™æµå’Œé™çº§ç­–ç•¥æ¥å¯¹èµ„æºç‚¹è¿›è¡Œä¿æŠ¤ã€‚åŒæ—¶è¿˜èƒ½é€šè¿‡ @SentinelResource æ¥æŒ‡å®šå‡ºç°å¼‚å¸¸æ—¶çš„å¤„ç†ç­–ç•¥</p>
<p>@SentinelResource ç”¨äºå®šä¹‰èµ„æºï¼Œå¹¶æä¾›å¯é€‰çš„å¼‚å¸¸å¤„ç†å’Œ fallback é…ç½®é¡¹ã€‚å…¶ä¸»è¦å‚æ•°å¦‚ä¸‹:</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041450222.png" srcset="/img/loading.gif" lazyload alt="image-20220804145032135"></p>
<h3 id="å®šä¹‰åœ¨æ–¹æ³•ä¸­"><a href="#å®šä¹‰åœ¨æ–¹æ³•ä¸­" class="headerlink" title="å®šä¹‰åœ¨æ–¹æ³•ä¸­"></a>å®šä¹‰åœ¨æ–¹æ³•ä¸­</h3><p>å¯ä»¥ç›´æ¥å°†é™æµå’Œé™çº§æ–¹æ³•å®šä¹‰åœ¨æ–¹æ³•ä¸­</p>
<p><strong>å®šä¹‰é™æµå’Œé™çº§æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl2</span> &#123;<br>    <span class="hljs-comment">// é€šè¿‡ @SentinelResource æ³¨è§£çš„ value å±æ€§æ¥æŒ‡å®šèµ„æºçš„åç§°</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;message&quot;,</span><br><span class="hljs-meta">            blockHandler = &quot;blockHandler&quot;, // å‘ç”Ÿ BlockException æ—¶è¿›å…¥çš„æ–¹æ³•</span><br><span class="hljs-meta">            fallback = &quot;fallback&quot; // å‘ç”Ÿ Throwable å¼‚å¸¸æ—¶ä¼šè¿›å…¥</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">message</span><span class="hljs-params">(Integer age)</span> &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†BlockExceptionçš„å‡½æ•°åç§°ï¼Œå‡½æ•°è¦æ±‚ï¼š</span><br><span class="hljs-comment">     * 1. å¿…é¡»æ˜¯ public</span><br><span class="hljs-comment">     * 2. è¿”å›ç±»å‹å‚æ•°ä¸åŸæ–¹æ³•ä¸€è‡´</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">blockHandler</span><span class="hljs-params">(Integer age, BlockException e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ¥å£è¢«é™æµäº†ã€‚ã€‚ã€‚ã€‚&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†Throwableçš„å‡½æ•°åç§°ï¼Œå‡½æ•°è¦æ±‚ï¼š</span><br><span class="hljs-comment">     * 1. å¿…é¡»æ˜¯ public</span><br><span class="hljs-comment">     * 2. è¿”å›ç±»å‹å‚æ•°ä¸åŸæ–¹æ³•ä¸€è‡´</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">(Integer age, Throwable e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ¥å£å‘ç”Ÿå¼‚å¸¸äº†ã€‚ã€‚ã€‚&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>è°ƒç”¨æ–¹æ³•</strong></p>
<p>åœ¨ OrderController æ§åˆ¶å™¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³• message()ï¼Œå¹¶åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨ Service ä¸­å®šä¹‰çš„ message() æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/message1&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message1</span><span class="hljs-params">()</span> &#123;<br>    orderServiceImpl2.message(<span class="hljs-number">20</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message1&quot;</span>;<br>&#125;	<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„è¦åœ¨åŠ äº† @SentinelResource æ³¨è§£çš„èµ„æºä¸Šæ·»åŠ é™æµæ‰ä¼šæœ‰æ•ˆæœ</p>
<h3 id="å®šä¹‰åœ¨å•ç‹¬ç±»ä¸­"><a href="#å®šä¹‰åœ¨å•ç‹¬ç±»ä¸­" class="headerlink" title="å®šä¹‰åœ¨å•ç‹¬ç±»ä¸­"></a>å®šä¹‰åœ¨å•ç‹¬ç±»ä¸­</h3><p>å°†é™æµå’Œé™çº§æ–¹æ³•å¤–ç½®åˆ°å•ç‹¬çš„ç±»ä¸­</p>
<p><strong>è‡ªå®šä¹‰å¤–éƒ¨BlockHandlerç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerBlockExceptionHandler</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯å®šä¹‰åœ¨ç±»çš„å¤–éƒ¨è¿™ä¸ªæ–¹æ³•å¿…é¡»æ˜¯é™æ€çš„æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">blockHandler</span><span class="hljs-params">(Integer age, BlockException e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ¥å£è¢«é™æµäº†ã€‚ã€‚ã€‚ã€‚&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>è‡ªå®šä¹‰å¤–éƒ¨Fallbackç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerFallbackHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">(Integer age, Throwable e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, e.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ¥å£å‘ç”Ÿå¼‚å¸¸äº†ã€‚ã€‚ã€‚&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šå½“å®šä¹‰ä¸ºå¤–éƒ¨ç±»æ—¶ï¼Œæ–¹æ³•å¿…é¡»æ˜¯ static çš„ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ</p>
</blockquote>
<p><strong>ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SentinelResource(value = &quot;message&quot;,</span><br><span class="hljs-meta">                  blockHandler = &quot;blockHandler&quot;, // å‘ç”Ÿ BlockException æ—¶è¿›å…¥çš„æ–¹æ³•</span><br><span class="hljs-meta">                  blockHandlerClass = CustomerBlockExceptionHandler.class,</span><br><span class="hljs-meta">                  fallback = &quot;fallback&quot;, // å‘ç”Ÿ Throwable å¼‚å¸¸æ—¶ä¼šè¿›å…¥</span><br><span class="hljs-meta">                  fallbackClass = CustomerFallbackHandler.class</span><br><span class="hljs-meta">)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">message</span><span class="hljs-params">(Integer age)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;message &quot;</span> + age;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041454502.png" srcset="/img/loading.gif" lazyload alt="image-20220804145450355"></p>
<h1 id="è§„åˆ™æŒä¹…åŒ–"><a href="#è§„åˆ™æŒä¹…åŒ–" class="headerlink" title="è§„åˆ™æŒä¹…åŒ–"></a>è§„åˆ™æŒä¹…åŒ–</h1><p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041455454.png" srcset="/img/loading.gif" lazyload alt="image-20220804145524393"></p>
<p>é¦–å…ˆ Sentinel æ§åˆ¶å°é€šè¿‡ API å°†è§„åˆ™æ¨é€è‡³å®¢æˆ·ç«¯å¹¶æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œæ¥ç€æ³¨å†Œçš„å†™æ•°æ®æºä¼šå°†æ–°çš„è§„åˆ™ä¿å­˜åˆ°æœ¬åœ°çš„æ–‡ä»¶ä¸­</p>
<h3 id="ç¼–å†™å¤„ç†ç±»"><a href="#ç¼–å†™å¤„ç†ç±»" class="headerlink" title="ç¼–å†™å¤„ç†ç±»"></a>ç¼–å†™å¤„ç†ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿™ä¸ªç±»æ˜¯ç”¨äºæŒä¹…åŒ– Sentinel çš„é…ç½®,å®ƒéœ€è¦å®ç° InitFunc æ¥å£</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilePersistence</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitFunc</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String applicationName;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ruleDir</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.home&quot;</span>) + <span class="hljs-string">&quot;/sentinel-rules/&quot;</span>+applicationName;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">flowRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/flow-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">degradeRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/degrade-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">systemRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/system-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authorityRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/authority-rule.json&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">paramFlowRulePath</span> <span class="hljs-operator">=</span> ruleDir + <span class="hljs-string">&quot;/param-flow-rule.json&quot;</span>;<br><br>        <span class="hljs-built_in">this</span>.mkdirIfNotExits(ruleDir);<br>        <span class="hljs-built_in">this</span>.createFileIfNotExits(flowRulePath);<br>        <span class="hljs-built_in">this</span>.createFileIfNotExits(degradeRulePath);<br>        <span class="hljs-built_in">this</span>.createFileIfNotExits(systemRulePath);<br>        <span class="hljs-built_in">this</span>.createFileIfNotExits(authorityRulePath);<br>        <span class="hljs-built_in">this</span>.createFileIfNotExits(paramFlowRulePath);<br><br>        <span class="hljs-comment">// æµæ§è§„åˆ™</span><br>        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(flowRulePath, flowRuleListParser);<br>        FlowRuleManager.register2Property(flowRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS = <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(flowRulePath, <span class="hljs-built_in">this</span>::encodeJson);<br>        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);<br><br>        <span class="hljs-comment">// é™çº§è§„åˆ™</span><br>        ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(degradeRulePath, degradeRuleListParser);<br>        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS = <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(degradeRulePath, <span class="hljs-built_in">this</span>::encodeJson);<br>        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);<br><br>        <span class="hljs-comment">// ç³»ç»Ÿè§„åˆ™</span><br>        ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(systemRulePath, systemRuleListParser);<br>        SystemRuleManager.register2Property(systemRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS = <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(systemRulePath, <span class="hljs-built_in">this</span>::encodeJson);<br>        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);<br><br>        <span class="hljs-comment">// æˆæƒè§„åˆ™</span><br>        ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(authorityRulePath, authorityRuleListParser);<br>        AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS = <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(authorityRulePath, <span class="hljs-built_in">this</span>::encodeJson);<br>        WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);<br><br>        <span class="hljs-comment">// çƒ­ç‚¹å‚æ•°è§„åˆ™</span><br>        ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileRefreshableDataSource</span>&lt;&gt;(paramFlowRulePath, paramFlowRuleListParser);<br>        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());<br>        WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS = <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">FileWritableDataSource</span>&lt;&gt;(paramFlowRulePath, <span class="hljs-built_in">this</span>::encodeJson);<br>        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser = source -&gt; JSON.parseObject(source, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;FlowRule&gt;&gt;() &#123;&#125;);<br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser = source<br>            -&gt; JSON.parseObject(source, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;DegradeRule&gt;&gt;() &#123;&#125;);<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser = source -&gt; JSON.parseObject(source, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;SystemRule&gt;&gt;() &#123;&#125;);<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser = source -&gt; JSON.parseObject(source, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;AuthorityRule&gt;&gt;() &#123;&#125;);<br><br>    <span class="hljs-keyword">private</span> Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser = source -&gt; JSON.parseObject(source, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;&#125;);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mkdirIfNotExits</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.mkdirs();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createFileIfNotExits</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.createNewFile();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> &lt;T&gt; String <span class="hljs-title function_">encodeJson</span><span class="hljs-params">(T t)</span> &#123;<br>        <span class="hljs-keyword">return</span> JSON.toJSONString(t);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="æ·»åŠ é…ç½®"><a href="#æ·»åŠ é…ç½®" class="headerlink" title="æ·»åŠ é…ç½®"></a>æ·»åŠ é…ç½®</h3><p>åœ¨resourcesä¸‹åˆ›å»ºé…ç½®ç›®å½• META-INF&#x2F;services ,ç„¶åæ·»åŠ æ–‡ä»¶</p>
<p><code>com.alibaba.csp.sentinel.init.InitFunc</code></p>
<h3 id="æ·»åŠ å†…å®¹"><a href="#æ·»åŠ å†…å®¹" class="headerlink" title="æ·»åŠ å†…å®¹"></a>æ·»åŠ å†…å®¹</h3><p>åœ¨æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ç±»çš„å…¨è·¯å¾„</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">com.openlab.config.FilePersistence</span><br></code></pre></td></tr></table></figure>

<p>åšå®Œä»¥ä¸Šæ­¥éª¤åï¼Œé‡æ–°å¯åŠ¨æœåŠ¡ï¼Œæ·»åŠ æµæ§è§„åˆ™ï¼Œç„¶åå†é‡æ–°å¯åŠ¨æœåŠ¡æ¥æŸ¥çœ‹æ•ˆæœ</p>
<h1 id="Feignæ•´åˆSentinel"><a href="#Feignæ•´åˆSentinel" class="headerlink" title="Feignæ•´åˆSentinel"></a>Feignæ•´åˆSentinel</h1><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Sentinel--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="å¼€å¯æ”¯æŒ"><a href="#å¼€å¯æ”¯æŒ" class="headerlink" title="å¼€å¯æ”¯æŒ"></a>å¼€å¯æ”¯æŒ</h3><p>åœ¨ sho-order å¾®æœçš„ application.yml é…ç½®æ–‡ä»¶ä¸­å¼€å¯Feignå¯¹Sentinelçš„æ”¯æŒ</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>    <span class="hljs-attr">sentinel:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h3 id="ç¼–å†™å®¹é”™"><a href="#ç¼–å†™å®¹é”™" class="headerlink" title="ç¼–å†™å®¹é”™"></a>ç¼–å†™å®¹é”™</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceFallBack</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getById</span><span class="hljs-params">(Long pid)</span> &#123;<br>        <span class="hljs-comment">// ç¼–å†™ä¸šåŠ¡ä»£ç </span><br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Product.builder()<br>                .id(<span class="hljs-number">1L</span>)<br>                .name(<span class="hljs-string">&quot;è¿œç¨‹è°ƒç”¨&quot;</span>)<br>                .price(<span class="hljs-number">100.00</span>)<br>                .build();<br>        <span class="hljs-keyword">return</span> product;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šåœ¨è¿™ä¸ªç±»ä¸­ï¼Œéœ€è¦å®ç° Fegin æ‰€åœ¨çš„æ¥å£ï¼Œå¹¶å»å®ç°æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œä¸€æ—¦Feginè¿œç¨‹è°ƒç”¨å‡ºç°é—®é¢˜ï¼Œå°±ä¼šè¿›å…¥å½“å‰ç±»ä¸­åŒåæ–¹æ³•ï¼Œæ‰§è¡Œå®¹é”™é€»è¾‘</p>
</blockquote>
<h3 id="æŒ‡å®šå®¹é”™ç±»"><a href="#æŒ‡å®šå®¹é”™ç±»" class="headerlink" title="æŒ‡å®šå®¹é”™ç±»"></a>æŒ‡å®šå®¹é”™ç±»</h3><p>ä¸ºè¢«å®¹å™¨çš„æ¥å£æŒ‡å®šå®¹é”™ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;service-product&quot;</span><br><span class="hljs-meta">        , fallback = ProductServiceFallBack.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductService</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;pid&#125;&quot;)</span><br>    Product <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>value ç”¨äºæŒ‡å®šè°ƒç”¨ nacos ä¸­å®šä¹‰çš„æœåŠ¡å</li>
<li>fallback ç”¨äºæŒ‡å®šå½“å‰çš„ Feign æ¥å£çš„å®¹é”™ç±»</li>
</ol>
</blockquote>
<h3 id="ä¿®æ”¹controller"><a href="#ä¿®æ”¹controller" class="headerlink" title="ä¿®æ”¹controller"></a>ä¿®æ”¹controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/prod/&#123;pid&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> &#123;<br>    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productService.getById(pid);<br>    <br>    log.info(<span class="hljs-string">&quot;æŸ¥è¯¢å•†å“ä¿¡æ¯ä¸º:&#123;&#125;&quot;</span>, product);<br><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> Order.builder()<br>        .uid(<span class="hljs-number">1L</span>)<br>        .username(<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>)<br>        .pid(product.getId())<br>        .pname(product.getName())<br>        .price(product.getPrice())<br>        .number(<span class="hljs-number">1</span>)<br>        .build();<br>    <span class="hljs-comment">//orderService.save(order);</span><br>    log.info(<span class="hljs-string">&quot;åˆ›å»ºè®¢å•æˆåŠŸ,è®¢å•ä¿¡æ¯ä¸º:&#123;&#125;&quot;</span>, order);<br>    <br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="è¿è¡Œæµ‹è¯•"><a href="#è¿è¡Œæµ‹è¯•" class="headerlink" title="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•</h3><p>å¯åŠ¨ shop-product æœåŠ¡å’Œ shop-order æœåŠ¡ï¼Œç„¶åè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8091/order/prod/1%EF%BC%8C%E5%8F%91%E7%8E%B0%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE%E7%9A%84%E3%80%82%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89">http://localhost:8091/order/prod/1ï¼Œå‘ç°æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœæ­¢æ‰€æœ‰</a> shop-product æœåŠ¡ï¼Œé‡å¯ shop-order æœåŠ¡ï¼Œè®¿é—®è¯·æ±‚è§‚å¯Ÿå®¹é”™æ•ˆ</p>
<h1 id="ğŸ“’æœåŠ¡ç½‘å…³"><a href="#ğŸ“’æœåŠ¡ç½‘å…³" class="headerlink" title="ğŸ“’æœåŠ¡ç½‘å…³"></a>ğŸ“’æœåŠ¡ç½‘å…³</h1><ul>
<li><p>Ngnix+lua</p>
</li>
<li><p>Kong</p>
</li>
<li><p>Zuul</p>
</li>
<li><p>Spring Cloud Gateway</p>
</li>
</ul>
<h1 id="å¿«é€Ÿä½¿ç”¨"><a href="#å¿«é€Ÿä½¿ç”¨" class="headerlink" title="å¿«é€Ÿä½¿ç”¨"></a>å¿«é€Ÿä½¿ç”¨</h1><blockquote>
<p>SPring Cloudä¸­ä½¿ç”¨</p>
</blockquote>
<h2 id="åˆ›å»ºæ¨¡å—"><a href="#åˆ›å»ºæ¨¡å—" class="headerlink" title="åˆ›å»ºæ¨¡å—"></a>åˆ›å»ºæ¨¡å—</h2><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å—ï¼Œapi-gateway</p>
<h2 id="å¼•å…¥ä¾èµ–-1"><a href="#å¼•å…¥ä¾èµ–-1" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--gateway --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™ä¸»ç±»"><a href="#ç¼–å†™ä¸»ç±»" class="headerlink" title="ç¼–å†™ä¸»ç±»"></a>ç¼–å†™ä¸»ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GatewayApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="æ·»åŠ é…ç½®-1"><a href="#æ·»åŠ é…ç½®-1" class="headerlink" title="æ·»åŠ é…ç½®"></a>æ·»åŠ é…ç½®</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-comment"># é…ç½® nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br>    <span class="hljs-comment"># é…ç½® gateway</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># è¡¨ç¤ºè®© gateway å¯ä»¥å‘ç° nacos ä¸­çš„æœåŠ¡</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># é…ç½®è·¯ç”±</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">product_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8081</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/product-api/**</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8091</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">2</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order-api/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<p>ç½‘å…³é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>routes: è·¯ç”±æ•°ç»„ï¼Œæ‰€è°“è·¯ç”±æ˜¯æŒ‡å®šå½“è¯·æ±‚æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æ—¶å€™è½¬åˆ°å“ªä¸ªå¾®æœåŠ¡</li>
<li>idï¼šå½“å‰è·¯ç”±çš„æ ‡è¯†ï¼Œè¦æ±‚å”¯ä¸€</li>
<li>uriï¼šè¯·æ±‚è¦è½¬å‘åˆ°çš„åœ°å€</li>
<li>orderï¼šè·¯ç”±çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜</li>
<li>predicatesï¼šæ–­è¨€ï¼Œæ‰€è°“æ–­è¨€æ˜¯æŒ‡è·¯ç”±è½¬å‘è¦æ»¡è¶³çš„æ¡ä»¶<ul>
<li>Pathï¼šå½“è¯·æ±‚è·¯å¾„æ»¡è¶³PathæŒ‡å®šçš„è§„åˆ™æ—¶ï¼Œæ‰è¿›è¡Œè·¯ç”±è½¬å‘</li>
</ul>
</li>
<li>filtersï¼šè¿‡æ»¤å™¨ï¼Œæ˜¯è¯·æ±‚åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å¯¹å…¶è¿›è¡Œä¸€å®šçš„ä¿®æ”¹<ul>
<li>StripPrefixï¼šè½¬å‘ä¹‹å‰å»æ‰ 1 å±‚è·¯å¾„</li>
</ul>
</li>
</ul>
<h2 id="å¯åŠ¨é¡¹ç›®"><a href="#å¯åŠ¨é¡¹ç›®" class="headerlink" title="å¯åŠ¨é¡¹ç›®"></a>å¯åŠ¨é¡¹ç›®</h2><p>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <a target="_blank" rel="noopener" href="http://localhost:7000/product-api/product/1%EF%BC%8C%E5%B9%B6%E9%80%9A%E8%BF%87%E7%BD%91%E5%85%B3%E5%8E%BB%E8%AE%BF%E9%97%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1">http://localhost:7000/product-api/product/1ï¼Œå¹¶é€šè¿‡ç½‘å…³å»è®¿é—®å¾®æœåŠ¡</a></p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041507701.png" srcset="/img/loading.gif" lazyload alt="image-20220804150731631"></p>
<h2 id="æ•´åˆNacos"><a href="#æ•´åˆNacos" class="headerlink" title="æ•´åˆNacos"></a>æ•´åˆNacos</h2><p>ç”±äºç½‘å…³ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœï¼Œå› æ­¤å®ƒä¹Ÿéœ€è¦æ³¨å†Œåˆ° Nacosçš„æ³¨å†Œä¸­ï¼Œå¹¶ä¸”å®ƒéœ€è¦ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡<br>åœ¨ api-gateway æ¨¡å—ä¸­æ·»åŠ  nacos çš„ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacoså®¢æˆ·ç«¯--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--è´Ÿè½½å‡è¡¡æ’ä»¶--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>æ·»åŠ å¥½ä¾èµ–ï¼Œè¿˜éœ€è¦åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  @EnableDiscoveryClient æ¥å¼€å¯ Nacos åŠŸèƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// å¼€å¯ Nacos åŠŸèƒ½</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APIGatApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(APIGatApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  Nacos çš„æœåŠ¡åœ°å€</p>
<blockquote>
<p>æ³¨æ„ï¼šå› ä¸ºä¸‹é¢ä½¿ç”¨äº†è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥å¿…é¡»è¦è¦åœ¨mavenä¸­å¯¼å…¥è´Ÿè½½å‡è¡¡çš„æ’ä»¶</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-comment"># é…ç½® nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br>    <span class="hljs-comment"># é…ç½® gateway</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># è¡¨ç¤ºè®© gateway å¯ä»¥å‘ç° nacos ä¸­çš„æœåŠ¡</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># é…ç½®è·¯ç”±</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">product_route</span><br><span class="hljs-comment">#          uri: http://localhost:8081</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-product</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/product-api/**</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order_route</span><br><span class="hljs-comment">#          uri: http://localhost:8091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">2</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order-api/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<p>é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ol>
<li>å°† gateway æ³¨å†Œåˆ° nacos ä¸­ï¼Œå› æ­¤è¦é…ç½® nacos çš„æœåŠ¡åœ°å€</li>
<li>gateway.discovery.locator.enabled&#x3D;true è¡¨ç¤ºè®©gatewayå¯ä»¥å‘ç°nacosä¸­çš„å¾®æœåŠ¡</li>
<li>gateway.routes.id&#x3D;product_route ä¸­çš„ product_route æ˜¯ç»™è¿™ä¸ªè·¯ç”±å–çš„æ ‡è¯†ï¼Œå³æœåŠ¡<br>åç§°</li>
<li>gateway.routes.uri&#x3D;lb:&#x2F;&#x2F;service-product ä¸­çš„ lbæŒ‡çš„æ˜¯ä» nacos ä¸­æŒ‰ç…§åç§°è·å–å¾®æœ<br>åŠ¡ï¼Œå¹¶éµå¾ªè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚è€Œ service-product æ˜¯ nacos ä¸­çš„æœåŠ¡åç§°</li>
</ol>
<h1 id="æ ¸å¿ƒæ¶æ„"><a href="#æ ¸å¿ƒæ¶æ„" class="headerlink" title="æ ¸å¿ƒæ¶æ„"></a>æ ¸å¿ƒæ¶æ„</h1><p>è·¯ç”±(Route) æ˜¯ gateway ä¸­æœ€åŸºæœ¬çš„ç»„ä»¶ä¹‹ä¸€ï¼Œè¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„è·¯ç”±ä¿¡æ¯è½½ä½“ã€‚ä¸»è¦å®šä¹‰äº†ä¸‹é¢çš„å‡ ä¸ªä¿¡æ¯:</p>
<ul>
<li>idï¼Œè·¯ç”±æ ‡è¯†ç¬¦ï¼ŒåŒºåˆ«äºå…¶ä»– Routeã€‚</li>
<li>uriï¼Œè·¯ç”±æŒ‡å‘çš„ç›®çš„åœ° uriï¼Œå³å®¢æˆ·ç«¯è¯·æ±‚æœ€ç»ˆè¢«è½¬å‘åˆ°çš„å¾®æœåŠ¡ã€‚</li>
<li>orderï¼Œç”¨äºå¤šä¸ª Route ä¹‹é—´çš„æ’åºï¼Œæ•°å€¼è¶Šå°æ’åºè¶Šé å‰ï¼ŒåŒ¹é…ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
<li>predicateï¼Œæ–­è¨€çš„ä½œç”¨æ˜¯è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ–­è¨€éƒ½è¿”å›çœŸï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±ã€‚</li>
<li>filterï¼Œè¿‡æ»¤å™¨ç”¨äºä¿®æ”¹è¯·æ±‚å’Œå“åº”ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>æ‰§è¡Œæµç¨‹</strong></p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208041510648.png" srcset="/img/loading.gif" lazyload alt="image-20220804151053531" style="zoom:50%;" />

<p>æ‰§è¡Œæµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> Gateway Clientå‘Gateway Serverå‘é€è¯·æ±‚<br><span class="hljs-bullet">2.</span> è¯·æ±‚é¦–å…ˆä¼šè¢«HttpWebHandlerAdapterè¿›è¡Œæå–ç»„è£…æˆç½‘å…³ä¸Šä¸‹æ–‡<br><span class="hljs-bullet">3.</span> ç„¶åç½‘å…³çš„ä¸Šä¸‹æ–‡ä¼šä¼ é€’åˆ°DispatcherHandlerï¼Œå®ƒè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™<br>RoutePredicateHandlerMapping<br><span class="hljs-bullet">4.</span> RoutePredicateHandlerMappingè´Ÿè´£è·¯ç”±æŸ¥æ‰¾ï¼Œå¹¶æ ¹æ®è·¯ç”±æ–­è¨€åˆ¤æ–­è·¯ç”±æ˜¯å¦å¯ç”¨<br><span class="hljs-bullet">5.</span> å¦‚æœè¿‡æ–­è¨€æˆåŠŸï¼Œç”±FilteringWebHandleråˆ›å»ºè¿‡æ»¤å™¨é“¾å¹¶è°ƒç”¨<br><span class="hljs-bullet">6.</span> è¯·æ±‚ä¼šä¸€æ¬¡ç»è¿‡PreFilter--å¾®æœåŠ¡--PostFilterçš„æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›å“åº”<br></code></pre></td></tr></table></figure>



<h1 id="æ–­è¨€â³"><a href="#æ–­è¨€â³" class="headerlink" title="æ–­è¨€â³"></a>æ–­è¨€â³</h1><h1 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h1><h2 id="å±€éƒ¨è¿‡æ»¤å™¨"><a href="#å±€éƒ¨è¿‡æ»¤å™¨" class="headerlink" title="å±€éƒ¨è¿‡æ»¤å™¨"></a>å±€éƒ¨è¿‡æ»¤å™¨</h2><p>å±€éƒ¨è¿‡æ»¤å™¨æ˜¯é’ˆå¯¹å•ä¸ªè·¯ç”±çš„è¿‡æ»¤å™¨</p>
<h3 id="å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨"><a href="#å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨" class="headerlink" title="å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨"></a>å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨</h3><p>åœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¾ˆå¤šä¸åŒç±»å‹çš„ç½‘å…³è·¯ç”±è¿‡æ»¤å™¨</p>
<h3 id="å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨çš„ä½¿ç”¨"><a href="#å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨çš„ä½¿ç”¨" class="headerlink" title="å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨çš„ä½¿ç”¨"></a>å†…ç½®å±€éƒ¨è¿‡æ»¤å™¨çš„ä½¿ç”¨</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order_route</span><br><span class="hljs-comment"># uri: http://localhost:8091</span><br><span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span><br><span class="hljs-attr">order:</span> <span class="hljs-number">2</span><br><span class="hljs-attr">predicates:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order-api/**</span><br><span class="hljs-attr">filters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">SetStatus=201</span> <span class="hljs-comment"># é…ç½®è®¾ç½®å“åº”çš„çŠ¶æ€ç </span><br></code></pre></td></tr></table></figure>

<h3 id="è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨</h3><p>1.åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªLogçš„è¿‡æ»¤å™¨é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order_route</span><br><span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span><br><span class="hljs-attr">order:</span> <span class="hljs-number">2</span><br><span class="hljs-attr">predicates:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order-api/**</span><br><span class="hljs-attr">filters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Log=true</span><br></code></pre></td></tr></table></figure>

<p>2.è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨å·¥å‚å¹¶å®ç°ç›¸åº”æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.chaoo.predicates;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰è¿‡æ»¤å™¨,</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogGatewayFilterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractGatewayFilterFactory</span>&lt;LogGatewayFilterFactory.Config&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogGatewayFilterFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(LogGatewayFilterFactory.Config.class);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">shortcutFieldOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Arrays.asList(<span class="hljs-string">&quot;flag&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GatewayFilter <span class="hljs-title function_">apply</span><span class="hljs-params">(Config config)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFilter</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>                <span class="hljs-keyword">if</span> (config.isFlag()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Logè¿‡æ»¤å·²ç»ç”Ÿæ•ˆäº†.....&quot;</span>);<br>                &#125;<br>                <span class="hljs-comment">// æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨</span><br>                <span class="hljs-keyword">return</span> chain.filter(exchange);<br>            &#125;<br>        &#125;;<br>    &#125;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-meta">@NoArgsConstructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> flag;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.å¯åŠ¨æµ‹è¯•</p>
<p>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <a target="_blank" rel="noopener" href="http://localhost:8091/product-api/product/1">http://localhost:8091/product-api/product/1</a> æ¥è¿›è¡Œè®¿é—®å¹¶æŸ¥çœ‹æ•ˆæœ</p>
<h2 id="å…¨å±€è¿‡æ»¤å™¨"><a href="#å…¨å±€è¿‡æ»¤å™¨" class="headerlink" title="å…¨å±€è¿‡æ»¤å™¨"></a>å…¨å±€è¿‡æ»¤å™¨</h2><p>å…¨å±€è¿‡æ»¤å™¨ä½œç”¨äºæ‰€æœ‰è·¯ç”±, æ— éœ€é…ç½®ã€‚é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°å¯¹æƒé™çš„ç»Ÿä¸€æ ¡éªŒï¼Œå®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½</p>
<h3 id="è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.chaoo.filter;<br><br><span class="hljs-keyword">import</span> com.alibaba.nacos.api.utils.StringUtils;<br><span class="hljs-keyword">import</span> io.netty.util.internal.StringUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-comment">//@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å®Œæˆåˆ¤æ–­çš„ä¸šåŠ¡é€»è¾‘</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chain</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">// è·å–è¯·æ±‚å‚æ•°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-comment">// StringUtils æ˜¯ nacos åŒ…ä¸­</span><br>        <span class="hljs-keyword">if</span> (!StringUtils.equals(<span class="hljs-string">&quot;admin&quot;</span>, token)) &#123;<br>            log.info(<span class="hljs-string">&quot;é‰´æƒå¤±è´¥....&quot;</span>);<br>            <span class="hljs-comment">// å‘å®¢æˆ·ç«¯å“åº”æ•°æ®</span><br>            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-comment">// å“åº”ä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€</span><br>            <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæ¡ä»¶æˆç«‹ï¼Œåˆ™æ‰§è¡Œç›®æ ‡å¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿‡æ»¤å™¨ä¼˜å…ˆçº§,æ•°å­—è¶Šå°è¶Šä¼˜å…ˆ</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡æ–°å¯åŠ¨æœåŠ¡åï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:7000/product-api/product/1%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%8E%B0%E4%B8%8D%E8%83%BD%E8%BF%94%E5%9B%9E%E4%BA%86%EF%BC%8C%E8%BF%94%E5%9B%9E401">http://localhost:7000/product-api/product/1ï¼Œä¼šå‘ç°ä¸èƒ½è¿”å›äº†ï¼Œè¿”å›401</a> çŠ¶æ€ç ã€‚å¦‚æœå¸Œæœ›èƒ½å¤Ÿè®¿é—®ï¼Œåˆ™éœ€è¦åŠ  token å‚æ•°ã€‚è¯·æ±‚é“¾æ¥ä¿®æ”¹ä¸ºï¼š<a target="_blank" rel="noopener" href="http://localhost:7000/product-api/product/1?token=admin">http://localhost:7000/product-api/product/1?token=admin</a></p>
<h1 id="ç½‘å…³é™æµ"><a href="#ç½‘å…³é™æµ" class="headerlink" title="ç½‘å…³é™æµ"></a>ç½‘å…³é™æµ</h1><h2 id="åŸºäºrouteç»´åº¦é™æµ"><a href="#åŸºäºrouteç»´åº¦é™æµ" class="headerlink" title="åŸºäºrouteç»´åº¦é™æµ"></a>åŸºäºrouteç»´åº¦é™æµ</h2><h3 id="1-å¯¼å…¥ä¾èµ–"><a href="#1-å¯¼å…¥ä¾èµ–" class="headerlink" title="1.å¯¼å…¥ä¾èµ–"></a><strong>1.å¯¼å…¥ä¾èµ–</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-ç¼–å†™é…ç½®ç±»"><a href="#2-ç¼–å†™é…ç½®ç±»" class="headerlink" title="2.ç¼–å†™é…ç½®ç±»"></a><strong>2.ç¼–å†™é…ç½®ç±»</strong></h3><p>åŸºäºSentinel çš„Gatewayé™æµæ˜¯é€šè¿‡å…¶æä¾›çš„Filteræ¥å®Œæˆçš„ï¼Œä½¿ç”¨æ—¶åªéœ€æ³¨å…¥å¯¹åº”çš„SentinelGatewayFilterå®ä¾‹ä»¥åŠ SentinelGatewayBlockExceptionHandler å®ä¾‹å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.openlab.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.SentinelGatewayConstants;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPathPredicateItem;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPredicateItem;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.GatewayApiDefinitionManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.ObjectProvider;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.core.annotation.Order;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.http.codec.ServerCodecConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.function.BodyInserters;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.result.view.ViewResolver;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åŸºäºrouteç»´åº¦é™æµ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfiguration</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GatewayConfiguration</span><span class="hljs-params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer)</span> &#123;<br>        <span class="hljs-built_in">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);<br>        <span class="hljs-built_in">this</span>.serverCodecConfigurer = serverCodecConfigurer;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªé™æµçš„è¿‡æ»¤å™¨</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span><br>    <span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title function_">sentinelGatewayFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentinelGatewayFilter</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// é…ç½®åˆå§‹åŒ–çš„é™æµå‚æ•°</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initGatewayRules</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/*Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;();</span><br><span class="hljs-comment">        rules.add(</span><br><span class="hljs-comment">                new GatewayFlowRule(&quot;product_route&quot;) //èµ„æºåç§°,å¯¹åº”è·¯ç”±id</span><br><span class="hljs-comment">                        .setCount(1) // é™æµé˜ˆå€¼</span><br><span class="hljs-comment">                        .setIntervalSec(1) // ç»Ÿè®¡æ—¶é—´çª—å£,å•ä½æ˜¯ç§’,é»˜è®¤æ˜¯ 1 ç§’</span><br><span class="hljs-comment">        );</span><br><span class="hljs-comment">        GatewayRuleManager.loadRules(rules);*/</span><br><br>        <span class="hljs-comment">// ä¸Šé¢çš„ä»£ç æ˜¯åŸºäº routeç»´åº¦è¿›è¡Œé™æµ</span><br>        <span class="hljs-comment">// ä¸‹é¢çš„ä»£ç æ˜¯åŸºäºè‡ªå®šä¹‰APIç»´åº¦è¿›è¡Œé™æµ</span><br><br>        Set&lt;GatewayFlowRule&gt; rules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFlowRule</span>(<span class="hljs-string">&quot;product_api1&quot;</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>));<br><br>        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFlowRule</span>(<span class="hljs-string">&quot;product_api2&quot;</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>));<br>        GatewayRuleManager.loadRules(rules);<br>    &#125;<br><br>    <span class="hljs-comment">// é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span><br>    <span class="hljs-keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="hljs-title function_">sentinelGatewayBlockExceptionHandler</span><span class="hljs-params">()</span>  &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentinelGatewayBlockExceptionHandler</span>(viewResolvers, serverCodecConfigurer);<br>    &#125;<br><br>    <span class="hljs-comment">// è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBlockHandlers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">BlockRequestHandler</span> <span class="hljs-variable">blockRequestHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockRequestHandler</span>() &#123;<br>            <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(ServerWebExchange</span><br><span class="hljs-params">                                                              serverWebExchange, Throwable throwable)</span> &#123;<br>                <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">0</span>);<br>                map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ¥å£è¢«é™æµäº†&quot;</span>);<br>                <span class="hljs-keyword">return</span> ServerResponse.status(HttpStatus.OK)<br>                        .contentType(MediaType.APPLICATION_JSON_UTF8)<br>                        .body(BodyInserters.fromObject(map));<br>            &#125;<br>        &#125;;<br>        GatewayCallbackManager.setBlockHandler(blockRequestHandler);<br>    &#125;<br><br><br>    <span class="hljs-comment">//è‡ªå®šä¹‰APIåˆ†ç»„</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCustomizedApis</span><span class="hljs-params">()</span> &#123;<br>        Set&lt;ApiDefinition&gt; definitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        <span class="hljs-type">ApiDefinition</span> <span class="hljs-variable">api1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiDefinition</span>(<span class="hljs-string">&quot;product_api1&quot;</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    <span class="hljs-comment">// ä»¥/product-serv/product/api1 å¼€å¤´çš„è¯·æ±‚</span><br>                    add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiPathPredicateItem</span>()<br>                            .setPattern(<span class="hljs-string">&quot;/product-api/product/api1/**&quot;</span>)<br>                            .setMatchStrategy(<br>                                    SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br><br>                &#125;&#125;);<br><br>        <span class="hljs-type">ApiDefinition</span> <span class="hljs-variable">api2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiDefinition</span>(<span class="hljs-string">&quot;product_api2&quot;</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    <span class="hljs-comment">// ä»¥/product-serv/product/api2/demo1 å®Œæˆçš„urlè·¯å¾„åŒ¹é…</span><br>                    add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiPathPredicateItem</span>()<br>                            .setPattern(<span class="hljs-string">&quot;/product-api/product/api2/demo1&quot;</span>));<br>                &#125;&#125;);<br>        definitions.add(api1);<br>        definitions.add(api2);<br><br>        GatewayApiDefinitionManager.loadApiDefinitions(definitions);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-å¯åŠ¨æµ‹è¯•-1"><a href="#3-å¯åŠ¨æµ‹è¯•-1" class="headerlink" title="3.å¯åŠ¨æµ‹è¯•"></a><strong>3.å¯åŠ¨æµ‹è¯•</strong></h3><p>é‡æ–°å¯åŠ¨æœåŠ¡ shop-product å’Œ shop-gateway æœåŠ¡ã€‚</p>
<p>åœ¨ä¸€ç§’é’Ÿå†…å¤šæ¬¡è®¿é—®<a target="_blank" rel="noopener" href="http://localhost:7000/product-api/product/1%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E9%99%90%E6%B5%81%E5%90%AF%E4%BD%9C%E7%94%A8%E4%BA%86">http://localhost:7000/product-api/product/1å°±å¯ä»¥çœ‹åˆ°é™æµå¯ä½œç”¨äº†</a></p>
<h2 id="è‡ªå®šä¹‰APIç»´åº¦é™æµ"><a href="#è‡ªå®šä¹‰APIç»´åº¦é™æµ" class="headerlink" title="è‡ªå®šä¹‰APIç»´åº¦é™æµ"></a>è‡ªå®šä¹‰APIç»´åº¦é™æµ</h2><p>è‡ªå®šä¹‰APIç»´åº¦é™æµæ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„é™æµè§„åˆ™å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.openlab.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.SentinelGatewayConstants;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPathPredicateItem;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPredicateItem;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.GatewayApiDefinitionManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;<br><span class="hljs-keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.ObjectProvider;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.core.annotation.Order;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.http.codec.ServerCodecConfigurer;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.function.BodyInserters;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.result.view.ViewResolver;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åŸºäºrouteç»´åº¦é™æµ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfiguration</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GatewayConfiguration</span><span class="hljs-params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer)</span> &#123;<br>        <span class="hljs-built_in">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);<br>        <span class="hljs-built_in">this</span>.serverCodecConfigurer = serverCodecConfigurer;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€ä¸ªé™æµçš„è¿‡æ»¤å™¨</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span><br>    <span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title function_">sentinelGatewayFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentinelGatewayFilter</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// é…ç½®åˆå§‹åŒ–çš„é™æµå‚æ•°</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initGatewayRules</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/*Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;();</span><br><span class="hljs-comment">        rules.add(</span><br><span class="hljs-comment">                new GatewayFlowRule(&quot;product_route&quot;) //èµ„æºåç§°,å¯¹åº”è·¯ç”±id</span><br><span class="hljs-comment">                        .setCount(1) // é™æµé˜ˆå€¼</span><br><span class="hljs-comment">                        .setIntervalSec(1) // ç»Ÿè®¡æ—¶é—´çª—å£,å•ä½æ˜¯ç§’,é»˜è®¤æ˜¯ 1 ç§’</span><br><span class="hljs-comment">        );</span><br><span class="hljs-comment">        GatewayRuleManager.loadRules(rules);*/</span><br><br>        <span class="hljs-comment">// ä¸Šé¢çš„ä»£ç æ˜¯åŸºäº routeç»´åº¦è¿›è¡Œé™æµ</span><br>        <span class="hljs-comment">// ä¸‹é¢çš„ä»£ç æ˜¯åŸºäºè‡ªå®šä¹‰APIç»´åº¦è¿›è¡Œé™æµ</span><br><br>        Set&lt;GatewayFlowRule&gt; rules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFlowRule</span>(<span class="hljs-string">&quot;product_api1&quot;</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>));<br><br>        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFlowRule</span>(<span class="hljs-string">&quot;product_api2&quot;</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>));<br>        GatewayRuleManager.loadRules(rules);<br>    &#125;<br><br>    <span class="hljs-comment">// é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span><br>    <span class="hljs-keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="hljs-title function_">sentinelGatewayBlockExceptionHandler</span><span class="hljs-params">()</span>  &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentinelGatewayBlockExceptionHandler</span>(viewResolvers, serverCodecConfigurer);<br>    &#125;<br><br>    <span class="hljs-comment">// è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBlockHandlers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">BlockRequestHandler</span> <span class="hljs-variable">blockRequestHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockRequestHandler</span>() &#123;<br>            <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(ServerWebExchange</span><br><span class="hljs-params">                                                              serverWebExchange, Throwable throwable)</span> &#123;<br>                <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">0</span>);<br>                map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ¥å£è¢«é™æµäº†&quot;</span>);<br>                <span class="hljs-keyword">return</span> ServerResponse.status(HttpStatus.OK)<br>                        .contentType(MediaType.APPLICATION_JSON_UTF8)<br>                        .body(BodyInserters.fromObject(map));<br>            &#125;<br>        &#125;;<br>        GatewayCallbackManager.setBlockHandler(blockRequestHandler);<br>    &#125;<br><br><br>    <span class="hljs-comment">//è‡ªå®šä¹‰APIåˆ†ç»„</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCustomizedApis</span><span class="hljs-params">()</span> &#123;<br>        Set&lt;ApiDefinition&gt; definitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        <span class="hljs-type">ApiDefinition</span> <span class="hljs-variable">api1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiDefinition</span>(<span class="hljs-string">&quot;product_api1&quot;</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    <span class="hljs-comment">// ä»¥/product-serv/product/api1 å¼€å¤´çš„è¯·æ±‚</span><br>                    add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiPathPredicateItem</span>()<br>                            .setPattern(<span class="hljs-string">&quot;/product-api/product/api1/**&quot;</span>)<br>                            .setMatchStrategy(<br>                                    SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br><br>                &#125;&#125;);<br><br>        <span class="hljs-type">ApiDefinition</span> <span class="hljs-variable">api2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiDefinition</span>(<span class="hljs-string">&quot;product_api2&quot;</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    <span class="hljs-comment">// ä»¥/product-serv/product/api2/demo1 å®Œæˆçš„urlè·¯å¾„åŒ¹é…</span><br>                    add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiPathPredicateItem</span>()<br>                            .setPattern(<span class="hljs-string">&quot;/product-api/product/api2/demo1&quot;</span>));<br>                &#125;&#125;);<br>        definitions.add(api1);<br>        definitions.add(api2);<br><br>        GatewayApiDefinitionManager.loadApiDefinitions(definitions);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ shop-product æœåŠ¡ä¸­çš„ ProductController ç±»ä¸­æ·»åŠ å‡ ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/product&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductService productService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;pid&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">product</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pid&quot;)</span> Long pid)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        log.info(<span class="hljs-string">&quot;æŸ¥è¯¢å•†å“ç¼–å·ä¸º &#123;&#125; çš„å•†å“ä¿¡æ¯&quot;</span>, pid);<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productService.getById(pid);<br>        log.info(<span class="hljs-string">&quot;æŸ¥è¯¢å•†å“æˆåŠŸ,å•†å“ä¿¡æ¯ä¸º &#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(product));<br>        <span class="hljs-comment">//TimeUnit.SECONDS.sleep(40);</span><br>        <span class="hljs-keyword">return</span> product;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/api1/demo1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;api1 demo1&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/api1/demo2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;api1 demo2&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/api2/demo1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;api2 demo1&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/api2/demo2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo4</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;api2 demo2&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡æ–°å¯åŠ¨ shop-product å’Œ shop-gateway ä¸¤ä¸ªæœåŠ¡ï¼Œç„¶åæ·»åŠ çš„å‡ ä¸ªè·¯å¾„</p>
<h1 id="ğŸ“’é“¾è·¯è¿½è¸ªâ³"><a href="#ğŸ“’é“¾è·¯è¿½è¸ªâ³" class="headerlink" title="ğŸ“’é“¾è·¯è¿½è¸ªâ³"></a>ğŸ“’é“¾è·¯è¿½è¸ªâ³</h1><h1 id="Sleuth"><a href="#Sleuth" class="headerlink" title="Sleuth"></a>Sleuth</h1><blockquote>
<p>é“¾è·¯è¿½è¸ª</p>
</blockquote>
<p>è®°å½•æ—¶é—´</p>
<h1 id="ZipKin"><a href="#ZipKin" class="headerlink" title="ZipKin"></a>ZipKin</h1><blockquote>
<p>é“¾è·¯è¿½è¸ª</p>
</blockquote>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208061713482.png" srcset="/img/loading.gif" lazyload alt="image-20220806171355346"></p>
<h1 id="ğŸ“’æœåŠ¡é…ç½®"><a href="#ğŸ“’æœåŠ¡é…ç½®" class="headerlink" title="ğŸ“’æœåŠ¡é…ç½®"></a>ğŸ“’æœåŠ¡é…ç½®</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> é…ç½®æ–‡ä»¶ç›¸å¯¹åˆ†æ•£ã€‚åœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé…ç½®æ–‡ä»¶ä¼šéšç€å¾®æœåŠ¡çš„å¢å¤šå˜çš„è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”åˆ†æ•£åœ¨å„ä¸ªå¾®æœåŠ¡ä¸­ï¼Œä¸å¥½ç»Ÿä¸€é…ç½®å’Œç®¡ç†<br><span class="hljs-bullet">2.</span> é…ç½®æ–‡ä»¶æ— æ³•åŒºåˆ†ç¯å¢ƒã€‚å¾®æœåŠ¡é¡¹ç›®å¯èƒ½ä¼šæœ‰å¤šä¸ªç¯å¢ƒï¼Œä¾‹å¦‚ï¼šæµ‹è¯•ç¯å¢ƒã€é¢„å‘å¸ƒç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒã€‚æ¯ä¸€ä¸ªç¯å¢ƒæ‰€ä½¿ç”¨çš„é…ç½®ç†è®ºä¸Šéƒ½æ˜¯ä¸åŒçš„ï¼Œä¸€æ—¦éœ€è¦ä¿®æ”¹ï¼Œå°±éœ€è¦æˆ‘ä»¬å»å„ä¸ªå¾®æœåŠ¡ä¸‹æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ¯”è¾ƒå›°éš¾<br><span class="hljs-bullet">3.</span> é…ç½®æ–‡ä»¶æ— æ³•å®æ—¶æ›´æ–°ã€‚æˆ‘ä»¬ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä¹‹åï¼Œå¿…é¡»é‡æ–°å¯åŠ¨å¾®æœåŠ¡æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆï¼Œè¿™å¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„é¡¹ç›®æ¥è¯´æ˜¯éå¸¸ä¸å‹å¥½<br></code></pre></td></tr></table></figure>

<p>åŸºäºä¸Šé¢è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦é…ç½®ä¸­å¿ƒçš„åŠ å…¥æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚ é…ç½®ä¸­å¿ƒçš„æ€è·¯æ˜¯ï¼š</p>
<ul>
<li>é¦–å…ˆæŠŠé¡¹ç›®ä¸­å„ç§é…ç½®å…¨éƒ¨éƒ½æ”¾åˆ°ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå¹¶æä¾›ä¸€å¥—æ ‡å‡†çš„æ¥å£ã€‚</li>
<li>å½“å„ä¸ªæœåŠ¡éœ€è¦è·å–é…ç½®çš„æ—¶å€™ï¼Œå°±æ¥é…ç½®ä¸­å¿ƒçš„æ¥å£æ‹‰å–è‡ªå·±çš„é…ç½®ã€‚</li>
<li>å½“é…ç½®ä¸­å¿ƒä¸­çš„å„ç§å‚æ•°æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½é€šçŸ¥åˆ°å„ä¸ªæœåŠ¡å®æ—¶çš„è¿‡æ¥åŒæ­¥æœ€æ–°çš„ä¿¡æ¯ï¼Œä½¿ä¹‹åŠ¨æ€æ›´æ–°</li>
</ul>
<p><strong>å¸¸è§çš„æœåŠ¡é…ç½®ä¸­å¿ƒ</strong></p>
<ul>
<li>Apollo</li>
<li>Disconf</li>
<li>Spring Cloud Config</li>
<li>Nacos</li>
</ul>
<h2 id="å¿«é€Ÿä½¿ç”¨-1"><a href="#å¿«é€Ÿä½¿ç”¨-1" class="headerlink" title="å¿«é€Ÿä½¿ç”¨"></a>å¿«é€Ÿä½¿ç”¨</h2><h3 id="å¯¼å…¥ä¾èµ–"><a href="#å¯¼å…¥ä¾èµ–" class="headerlink" title="å¯¼å…¥ä¾èµ–"></a>å¯¼å…¥ä¾èµ–</h3><blockquote>
<p>åœ¨ shop-product å¾®æœåŠ¡ä¸­å¼•å…¥nacos é…ç½®ä¸­å¿ƒçš„ä¾èµ–</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="é…ç½®å†…å®¹"><a href="#é…ç½®å†…å®¹" class="headerlink" title="é…ç½®å†…å®¹"></a>é…ç½®å†…å®¹</h3><p><strong>æ·»åŠ é…ç½®</strong></p>
<p>è¿›å…¥ Nacos æ§åˆ¶å°ï¼Œæ‰¾ä»¥é…ç½®ç®¡ç†ä¸­çš„é…ç½®åˆ—è¡¨ï¼Œç‚¹å‡»å³è¾¹çš„â€œ+â€å·ï¼Œæ‰“å¼€é…ç½®ç•Œé¢æ¥æ–°å¢ä¸€ä¸ªé…ç½®</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051010414.png" srcset="/img/loading.gif" lazyload alt="image-20220805101022243"></p>
<p><strong>å¼•å…¥é…ç½®</strong></p>
<p>å½“åœ¨ Nacos ä¸­é…ç½®å¥½åï¼Œè¿˜éœ€è¦æŠŠ Nacos ä¸­çš„é…ç½®å¼•å…¥åˆ° shop-product å¾®æœä¸­æ¥ã€‚è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ shop-product å¾®æœä¸­çš„ resources ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªå« bootstrap.yml æ–‡ä»¶</p>
<blockquote>
<p>æ³¨æ„ï¼šä¸èƒ½ä½¿ç”¨åŸæ¥çš„ application.yml ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œè€Œæ˜¯æ–°å»ºä¸€ä¸ª bootstrap.yml ä½œä¸ºé…ç½®æ–‡ä»¶</p>
<p>åœ¨ SpringBoot ä¸­ï¼Œé»˜è®¤å®šä¹‰äº†ä»¥ä¸‹å››ç§é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”åŠ è½½é¡ºåºå¦‚ä¸‹ï¼š<br>bootstrap.properties -&gt; bootstrap.yml -&gt; application.properties -&gt; application.yml</p>
</blockquote>
<p>ç„¶ååœ¨ bootstrap.yml æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹æ¥è¿›è¡Œå¼•å…¥</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-product</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-comment"># è·å–é…ç½®ä¸­å¿ƒåœ°å€</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br>        <span class="hljs-comment"># é…ç½®æ–‡ä»¶æ ¼å¼</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-comment"># ç¯å¢ƒæ ‡è¯†</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šåœ¨ bootstrap.yml æ–‡ä»¶ä¸­é…ç½®æœåŠ¡åç§°ä¸º service-productï¼Œå› æ­¤åœ¨ Nacos é…ç½®çš„ DataID å¤„çš„åç§°æ ¼å¼ä¸ºï¼šservice-product-dev.ymlï¼Œä¹Ÿå°±æ˜¯ <code>æœåŠ¡åç§°-ç¯å¢ƒæ ‡è¯†.é…ç½®æ–‡ä»¶æ ¼å¼</code></p>
</blockquote>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051011311.png" srcset="/img/loading.gif" lazyload alt="image-20220805101124217"></p>
<p>SpringBoot åŠ è½½ bootstrap.yml æ–‡ä»¶éœ€è¦å¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨æµ‹è¯•"><a href="#å¯åŠ¨æµ‹è¯•" class="headerlink" title="å¯åŠ¨æµ‹è¯•"></a>å¯åŠ¨æµ‹è¯•</h3><p>æ³¨é‡Šæœ¬åœ°çš„ application.yam ä¸­çš„å†…å®¹ï¼Œ å¯åŠ¨ç¨‹åºè¿›è¡Œæµ‹è¯•</p>
<p>å¦‚æœä¾æ—§å¯ä»¥æˆåŠŸè®¿é—®ç¨‹åºï¼Œè¯´æ˜æˆ‘ä»¬nacosçš„é…ç½®ä¸­å¿ƒåŠŸèƒ½å·²ç»å®ç°</p>
<h2 id="é…ç½®åŠ¨æ€åˆ·æ–°"><a href="#é…ç½®åŠ¨æ€åˆ·æ–°" class="headerlink" title="é…ç½®åŠ¨æ€åˆ·æ–°"></a>é…ç½®åŠ¨æ€åˆ·æ–°</h2><p>1.ä¿®æ”¹Nacosé…ç½®</p>
<p>åœ¨ <code>nacos </code>ä¸­çš„ service-product-dev.yaml é…ç½®é¡¹ä¸­æ·»åŠ ä¸‹é¢é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">config:</span><br>    <span class="hljs-attr">appName:</span> <span class="hljs-string">product</span><br></code></pre></td></tr></table></figure>

<p>2.ç¡¬ç¼–ç æ–¹å¼</p>
<p>åœ¨ shop-product å¾®æœä¸­æ–°å»ºä¸€ä¸ªæ§åˆ¶å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-comment">//@RefreshScope // ä¹‹å‰ç‰ˆæœ¬ä¸­éœ€è¦æ·»åŠ è¿™ä¸ªæ³¨è§£,æ–°ç‰ˆæœ¬ä¸­ä¸ç”¨</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosConfigController</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºå¯åŠ¨ Nacos ä¸­çš„é…ç½®</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ConfigurableApplicationContext applicationContext;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/nacos-config&quot;)</span><br>    <span class="hljs-keyword">public</span> String  <span class="hljs-title function_">nacos</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(<span class="hljs-string">&quot;config.appName&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¼–å†™å¥½çš„ï¼Œé‡æ–°å¯åŠ¨ shop-product å¾®æœï¼Œç„¶åè®¿é—® http&#x2F;&#x2F;localhost:8081&#x2F;product&#x2F;nacos-config å¯ä»¥å‘ç°èƒ½å¤Ÿè·å–åˆ° Nacos ä¸­çš„é…ç½®ä¿¡æ¯ã€‚å†æ¬¡ä¿®æ”¹ Nacos ä¸­çš„ config.appName çš„å€¼ä¸º product1ï¼Œç„¶åå†åˆ·æ–°é¡µé¢ï¼Œå¯ä»¥å‘ç°èƒ½å¤ŸåŠ¨æ€æ›´æ–°</p>
<h2 id="é…ç½®å…±äº«"><a href="#é…ç½®å…±äº«" class="headerlink" title="é…ç½®å…±äº«"></a>é…ç½®å…±äº«</h2><h3 id="ç›¸åŒå¾®æœåŠ¡ä¸åŒç¯å¢ƒé…ç½®å…±äº«"><a href="#ç›¸åŒå¾®æœåŠ¡ä¸åŒç¯å¢ƒé…ç½®å…±äº«" class="headerlink" title="ç›¸åŒå¾®æœåŠ¡ä¸åŒç¯å¢ƒé…ç½®å…±äº«"></a>ç›¸åŒå¾®æœåŠ¡ä¸åŒç¯å¢ƒé…ç½®å…±äº«</h3><blockquote>
<p>å¦‚æœæƒ³åœ¨åŒä¸€ä¸ªå¾®æœåŠ¡çš„ä¸åŒç¯å¢ƒä¹‹é—´å®ç°é…ç½®å…±äº«ï¼Œå…¶å®å¾ˆç®€å•ã€‚åªéœ€è¦æå–ä¸€ä¸ªä»¥ spring.application.name å‘½åçš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå°†å…¶æ‰€æœ‰ç¯å¢ƒçš„å…¬å…±é…ç½®æ”¾åœ¨é‡Œé¢å³å¯</p>
</blockquote>
<p>æ–°å»ºä¸€ä¸ªåä¸ºservice-product.yamlé…ç½®å­˜æ”¾å•†å“å¾®æœåŠ¡çš„å…¬å…±é…ç½®</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051023685.png" srcset="/img/loading.gif" lazyload alt="image-20220805102355581"></p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208051024865.png" srcset="/img/loading.gif" lazyload alt="image-20220805102405774"></p>
<h3 id="ä¸åŒå¾®æœåŠ¡ä¹‹é—´é…ç½®å…±äº«"><a href="#ä¸åŒå¾®æœåŠ¡ä¹‹é—´é…ç½®å…±äº«" class="headerlink" title="ä¸åŒå¾®æœåŠ¡ä¹‹é—´é…ç½®å…±äº«"></a>ä¸åŒå¾®æœåŠ¡ä¹‹é—´é…ç½®å…±äº«</h3><p>ä¸åŒä¸ºæœåŠ¡ä¹‹é—´å®ç°é…ç½®å…±äº«çš„åŸç†ç±»ä¼¼äºæ–‡ä»¶å¼•å…¥ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªå…¬å…±é…ç½®ï¼Œç„¶ååœ¨å½“å‰é…ç½®ä¸­å¼•å…¥</p>
<p>1.åœ¨nacosä¸­å®šä¹‰ä¸€ä¸ªDataIDä¸º share-config.yaml çš„é…ç½®ï¼Œç”¨äºæ‰€æœ‰å¾®æœåŠ¡å…±äº«</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-product</span><br>    <span class="hljs-comment"># é…ç½®æ•°æ®åº“é“¾æ¥ä¿¡æ¯</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.33.135:3306/shop?useSSL=false&amp;characterEncoding=UTF8</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-comment"># é…ç½® nacos</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br>      <br><span class="hljs-comment"># é…ç½® Mybatis-Plus</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span> <span class="hljs-comment"># æ§åˆ¶å°è¾“å‡º SQL</span><br></code></pre></td></tr></table></figure>

<p>2.åœ¨nacosçš„ä¸­ä¿®æ”¹ service-product.yaml ä¸­ä¸ºä¸‹é¢å†…å®¹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">config:</span><br>    <span class="hljs-attr">appName:</span> <span class="hljs-string">product</span><br></code></pre></td></tr></table></figure>

<p>3.ä¿®æ”¹bootstrap.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-product</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-comment"># è·å–é…ç½®ä¸­å¿ƒåœ°å€</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.33</span><span class="hljs-number">.135</span><span class="hljs-string">:8848</span><br>        <span class="hljs-comment"># é…ç½®æ–‡ä»¶æ ¼å¼</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">shared-dataids:</span> <span class="hljs-string">share-config.yaml</span> <span class="hljs-comment"># é…ç½®è¦å¼•å…¥çš„é…ç½®</span><br>        <span class="hljs-attr">refreshable-dataids:</span> <span class="hljs-string">share-config.yaml</span> <span class="hljs-comment"># é…ç½®è¦å®ç°åŠ¨æ€é…ç½®åˆ·æ–°çš„é…ç½®</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-comment"># ç¯å¢ƒæ ‡è¯†</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<p>4.å¯åŠ¨å•†å“å¾®æœåŠ¡è¿›è¡Œæµ‹è¯•</p>
<h1 id="ğŸ“’åˆ†å¸ƒå¼äº‹åŠ¡â³"><a href="#ğŸ“’åˆ†å¸ƒå¼äº‹åŠ¡â³" class="headerlink" title="ğŸ“’åˆ†å¸ƒå¼äº‹åŠ¡â³"></a>ğŸ“’åˆ†å¸ƒå¼äº‹åŠ¡â³</h1><p>åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Š</p>
<p>ç®€å•çš„è¯´ï¼Œå°±æ˜¯ä¸€æ¬¡å¤§çš„æ“ä½œç”±ä¸åŒçš„å°æ“ä½œç»„æˆï¼Œè¿™äº›å°çš„æ“ä½œåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä¸”å±äºä¸åŒçš„åº”ç”¨ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯è¿™äº›å°æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</p>
<p>æœ¬è´¨ä¸Šæ¥è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯ä¸ºäº†ä¿è¯ä¸åŒæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§</p>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"></a>åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</h2><h3 id="å…¨å±€äº‹åŠ¡"><a href="#å…¨å±€äº‹åŠ¡" class="headerlink" title="å…¨å±€äº‹åŠ¡"></a>å…¨å±€äº‹åŠ¡</h3><h3 id="å¯é æ¶ˆæ¯æœåŠ¡"><a href="#å¯é æ¶ˆæ¯æœåŠ¡" class="headerlink" title="å¯é æ¶ˆæ¯æœåŠ¡"></a>å¯é æ¶ˆæ¯æœåŠ¡</h3><h3 id="æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="æœ€å¤§åŠªåŠ›é€šçŸ¥"></a>æœ€å¤§åŠªåŠ›é€šçŸ¥</h3><h3 id="TCCäº‹åŠ¡"><a href="#TCCäº‹åŠ¡" class="headerlink" title="TCCäº‹åŠ¡"></a>TCCäº‹åŠ¡</h3><h1 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h1><blockquote>
<p>åˆ†å¸ƒå¼äº‹åŠ¡</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Springcloud/" class="category-chain-item">Springcloud</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Springcloud/">#Springcloud</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringcloudAlibaba-</div>
      <div>http://example.com/2022/07/31/2022-7-31-SpringCloud/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Chaoo</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´7æœˆ31æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/31/2022-7-31-ElasticSearch%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA/" title="ElasticSearchæ¡ˆä¾‹æ¼”ç¤º">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ElasticSearchæ¡ˆä¾‹æ¼”ç¤º</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/31/2022-7-31-SpringCloudError/" title="SpringcloudAlibabaError">
                        <span class="hidden-mobile">SpringcloudAlibabaError</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
