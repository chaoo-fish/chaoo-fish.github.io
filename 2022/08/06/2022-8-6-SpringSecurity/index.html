

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Chaoo">
  <meta name="keywords" content="Java, Blog">
  
    <meta name="description" content="SpringSecurityå­¦ä¹ ">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity">
<meta property="og:url" content="http://example.com/2022/08/06/2022-8-6-SpringSecurity/index.html">
<meta property="og:site_name" content="éšé£">
<meta property="og:description" content="SpringSecurityå­¦ä¹ ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081832803.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081832741.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081841961.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081845305.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081850021.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081902073.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081903726.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081906611.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081909642.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081920352.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081923475.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208100925044.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208100926821.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208101020768.png">
<meta property="og:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208101022493.png">
<meta property="article:published_time" content="2022-08-05T16:00:00.000Z">
<meta property="article:modified_time" content="2022-08-05T16:00:00.000Z">
<meta property="article:author" content="Chaoo">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringSecurity">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081832803.png">
  
  
  
  <title>SpringSecurity - éšé£</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Chaoo</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringSecurity"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-06 00:00" pubdate>
          2022å¹´8æœˆ6æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          27k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          222 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringSecurity</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Spring Security æ˜¯ Spring å®¶æ—çš„ä¸€å‘˜</p>
<ul>
<li>ç”¨æˆ·éªŒè¯</li>
<li>ç”¨æˆ·æˆæƒ</li>
</ul>
<h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--å¯¼MybatisPlusåŒ…--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="ç¼–å†™æ§åˆ¶å™¨"><a href="#ç¼–å†™æ§åˆ¶å™¨" class="headerlink" title="ç¼–å†™æ§åˆ¶å™¨"></a>ç¼–å†™æ§åˆ¶å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello spring security&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ç¼–å†™å¯åŠ¨ç±»"><a href="#ç¼–å†™å¯åŠ¨ç±»" class="headerlink" title="ç¼–å†™å¯åŠ¨ç±»"></a>ç¼–å†™å¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SecurityApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ç¼–å†™é…ç½®æ–‡ä»¶"><a href="#ç¼–å†™é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–å†™é…ç½®æ–‡ä»¶"></a>ç¼–å†™é…ç½®æ–‡ä»¶</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br></code></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨é¡¹ç›®"><a href="#å¯åŠ¨é¡¹ç›®" class="headerlink" title="å¯åŠ¨é¡¹ç›®"></a>å¯åŠ¨é¡¹ç›®</h3><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081832803.png" srcset="/img/loading.gif" lazyload alt="image-20220808183234659" style="zoom:67%;" />

<p>ç„¶åè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8081/hello">http://localhost:8081/hello</a> ä¼šå‡ºç°ä¸€ä¸ªç™»å½•çª—å£</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081832741.png" srcset="/img/loading.gif" lazyload alt="image-20220808183242684" style="zoom: 50%;" />

<p>ä½¿ç”¨ user è¿™ä¸ªç™»å½•åç§°å’Œä¸Šé¢ç”Ÿæˆçš„å¯†ç å°±å¯ä»¥ç™»å½•</p>
<h1 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h1><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/5.7.1/servlet/getting-started.html">https://docs.spring.io/spring-security/reference/5.7.1/servlet/getting-started.html</a></p>
<p>Spring Security åŠŸèƒ½çš„ä¸»è¦å®ç°ä¸»è¦æ˜¯ç”± ä¸€ç³»åˆ—è¿‡æ»¤å™¨é“¾ç›¸äº’é…åˆå®Œæˆçš„</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.context</span><span class="hljs-selector-class">.request</span><span class="hljs-selector-class">.async</span><span class="hljs-selector-class">.WebAsyncManagerIntegrationFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.context</span><span class="hljs-selector-class">.SecurityContextPersistenceFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.header</span><span class="hljs-selector-class">.HeaderWriterFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.csrf</span><span class="hljs-selector-class">.CsrfFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.logout</span><span class="hljs-selector-class">.LogoutFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.UsernamePasswordAuthenticationFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.DefaultLoginPageGeneratingFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.DefaultLogoutPageGeneratingFi</span><br>lter org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.savedrequest</span><span class="hljs-selector-class">.RequestCacheAwareFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.servletapi</span><span class="hljs-selector-class">.SecurityContextHolderAwareRequestFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.AnonymousAuthenticationFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.session</span><span class="hljs-selector-class">.SessionManagementFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.access</span><span class="hljs-selector-class">.ExceptionTranslationFilter</span><br>org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.access</span><span class="hljs-selector-class">.intercept</span>.FilterSecurityInterceptor<br></code></pre></td></tr></table></figure>

<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081841961.png" srcset="/img/loading.gif" lazyload alt="image-20220808184131915"></p>
<p>ä¸‹é¢æ˜¯éƒ¨åˆ†è¿‡æ»¤å™¨</p>
<h2 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h2><p>è¿™ä¸ªè¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªæ–¹æ³•çº§åˆ«çš„æƒé™è¿‡æ»¤å™¨,åŸºæœ¬ä½äºè¿‡æ»¤å™¨çš„æœ€åº•éƒ¨,ç”¨äºä¿æŠ¤ web èµ„æº,ä½¿ç”¨ AccessDecisionManager å¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæˆæƒè®¿é—®</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081845305.png" srcset="/img/loading.gif" lazyload alt="image-20220808184522243" style="zoom:67%;" />

<p><code>super.beforeInvocation(filterInvocation)</code></p>
<p><code>filterInvocation.getChain().doFilter(filterInvocation.getRequest(), filterInvocation.getResponse())</code></p>
<h2 id="ExceptionTranslationFilterâ³"><a href="#ExceptionTranslationFilterâ³" class="headerlink" title="ExceptionTranslationFilterâ³"></a>ExceptionTranslationFilterâ³</h2><p>è¿™ä¸ªè¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªå¼‚å¸¸è¿‡æ»¤å™¨,ç”¨æ¥å¤„ç†åœ¨è®¤è¯æˆæƒè¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸,èƒ½å¤Ÿæ•è·æ¥åŠ FilterChain æ‰€æœ‰å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†</p>
<p>ä½†æ˜¯å®ƒåªä¼šæŠ›å‡ºä¸¤ç±»å¼‚å¸¸ <code>AuthenticationException </code>å’Œ <code>AccessDeniedException</code> ,å…¶å®ƒçš„å¼‚å¸¸ä¼šç»§ç»­æŠ›å‡º</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081850021.png" srcset="/img/loading.gif" lazyload alt="image-20220808185009961" style="zoom:67%;" />

<h2 id="UsernamePasswordAuthenticationFilter"><a href="#UsernamePasswordAuthenticationFilter" class="headerlink" title="UsernamePasswordAuthenticationFilter"></a>UsernamePasswordAuthenticationFilter</h2><p>è¿™ä¸ªè¿‡æ»¤å™¨æ˜¯å¯¹ &#x2F;login çš„ POST è¯·æ±‚åšæ‹¦æˆªï¼Œæ ¡éªŒè¡¨å•ä¸­ç”¨æˆ·åå’Œå¯†ç ã€‚ç”¨äºå¤„ç†æ¥è‡ªè¡¨å•æäº¤çš„è®¤è¯ã€‚</p>
<p>è¯¥è¡¨å•å¿…é¡»æä¾›å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶å†…éƒ¨è¿˜æœ‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åè¿›è¡Œå¤„ç†çš„<code>AuthenticationSuccessHandler </code>å’Œ <code>AuthenticationFailureHandler</code> </p>
<blockquote>
<p>PS:ä½†æ˜¯æˆ‘åœ¨æœ¬ç±»å¹¶æ²¡æœ‰æ‰¾åˆ°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAuthenticationProcessingFilter</span> &#123;<br>	<span class="hljs-comment">// è¡¨å•çš„ç”¨æˆ·å</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>	<span class="hljs-comment">// è¡¨å•çš„å¯†ç </span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br>	<span class="hljs-comment">// å¤„ç†è¡¨å•çš„è¯·æ±‚è·¯å¾„ä¸º /login , è¯·æ±‚æ–¹å¼å¿…é¡»ä¸º POST</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AntPathRequestMatcher</span> <span class="hljs-variable">DEFAULT_ANT_PATH_REQUEST_MATCHER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/login&quot;</span>,<br>			<span class="hljs-string">&quot;POST&quot;</span>);<br>	<span class="hljs-comment">// è¿™æ˜¯ç”¨äºåç»§ä¿®æ”¹è¡¨å•åç§°çš„</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">usernameParameter</span> <span class="hljs-operator">=</span> SPRING_SECURITY_FORM_USERNAME_KEY;<br>	<span class="hljs-comment">// è¿™æ˜¯ç”¨äºåç»§ä¿®æ”¹è¡¨å•åç§°çš„</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">passwordParameter</span> <span class="hljs-operator">=</span> SPRING_SECURITY_FORM_PASSWORD_KEY;<br>	<span class="hljs-comment">// é»˜è®¤åªæ”¯æŒ POST æäº¤</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">postOnly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">UsernamePasswordAuthenticationFilter</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-built_in">super</span>(DEFAULT_ANT_PATH_REQUEST_MATCHER);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">UsernamePasswordAuthenticationFilter</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> &#123;<br>		<span class="hljs-built_in">super</span>(DEFAULT_ANT_PATH_REQUEST_MATCHER, authenticationManager);<br>	&#125;<br>	<br>    <span class="hljs-comment">// å¤„ç†ç™»å½•è®¤è¯çš„é€»è¾‘</span><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span><br>			<span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>         <span class="hljs-comment">// å¦‚æœè®¾ç½®ä¸ºåªæ”¯æŒ POST æäº¤æ–¹å¼ï¼Œè€Œè¡¨å•æäº¤æ—¶ä¸æ˜¯ POST æ–¹å¼åˆ™æŠ›å‡ºå¼‚å¸¸ </span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>)) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());<br>		&#125;<br>        <span class="hljs-comment">// è·å–ç”¨æˆ·å</span><br>		<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> obtainUsername(request);<br>		username = (username != <span class="hljs-literal">null</span>) ? username.trim() : <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-comment">// è·å–å¯†ç </span><br>		<span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> obtainPassword(request);<br>		password = (password != <span class="hljs-literal">null</span>) ? password : <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-comment">// è®¤è¯</span><br>		<span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.unauthenticated(username,<br>				password);<br>		<span class="hljs-comment">// Allow subclasses to set the &quot;details&quot; property</span><br>		setDetails(request, authRequest);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<p>å¯¹äºè®¤è¯æ¥è¯´æœ‰ä¸¤ç§ç»“æœï¼šä¸€ç§æ˜¯æˆåŠŸï¼Œä¸€ç§æ˜¯å¤±è´¥ã€‚</p>
<p>**<code>SecurityContextPersistenceFilter</code>**ï¼šè¿™ä¸ªFilteræ˜¯æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹çš„å…¥å£å’Œå‡ºå£ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼‰ï¼Œä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»é…ç½®å¥½çš„ SecurityContextRepository ä¸­è·å– SecurityContextï¼Œç„¶åæŠŠå®ƒè®¾ç½®ç»™ SecurityContextHolderã€‚åœ¨è¯·æ±‚å®Œæˆåå°† SecurityContextHolder<br>æŒæœ‰çš„ SecurityContext å†ä¿å­˜åˆ°é…ç½®å¥½çš„ SecurityContextRepositoryï¼ŒåŒæ—¶æ¸…é™¤ securityContextHolder æ‰€æŒæœ‰çš„ SecurityContext</p>
<h2 id="è¿‡æ»¤å™¨åŠ è½½è¿‡ç¨‹"><a href="#è¿‡æ»¤å™¨åŠ è½½è¿‡ç¨‹" class="headerlink" title="è¿‡æ»¤å™¨åŠ è½½è¿‡ç¨‹"></a>è¿‡æ»¤å™¨åŠ è½½è¿‡ç¨‹</h2><p>åœ¨ä½¿ç”¨ SpringSecurity ä¹‹å‰ï¼Œåº”è¯¥è¦å…ˆé…ç½®è¿‡æ»¤å™¨ï¼Œåœ¨ä¹‹å‰çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥æ²¡æœ‰é…ç½®è¿‡æ»¤å™¨çš„åŸå› æ˜¯å› ä¸º SpringBoot å·²ç»å¸®æˆ‘ä»¬è‡ªåŠ¨è£…é…äº†è¿™äº›è¿‡æ»¤å™¨ã€‚åœ¨ SpringBoot ä¸­æ˜¯é€šè¿‡ DelegatingFilterProxy æ¥å®ç°çš„ã€‚</p>
<p>åœ¨ IDEA ä¸­æœç´¢ DelegatingFilterProxyï¼Œæ‰¾åˆ°åæˆ‘ä»¬è¿›å…¥è¿™ä¸ªè¿‡æ»¤å™¨çš„æºç ä¸­ï¼Œå¹¶åœ¨æºç ä¸­æ‰¾åˆ° doFilter() æ–¹æ³•</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081902073.png" srcset="/img/loading.gif" lazyload alt="image-20220808190216006" style="zoom:67%;" />

<p>è¿›å…¥åˆ° initDelegate() åˆå§‹åŒ–ä»£ç†æ–¹æ³•</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081903726.png" srcset="/img/loading.gif" lazyload alt="image-20220808190313675" style="zoom:67%;" />

<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé¦–å…ˆè·å–ç›®æ ‡å¯¹è±¡çš„åç§°ï¼Œè€Œè¿™ä¸ªåç§°æ˜¯ä¸€ä¸ªåå« springSecurityFilterChain çš„ <strong>Bean</strong>ã€‚å½“æ–­ç‚¹ç»§ç»­å‘ä¸‹æ‰§è¡Œæ—¶ï¼Œä¼šè¿›å…¥åˆ° FilterChainProxy ç±»ä¸­çš„ getFilters() æ–¹æ³•ä¸­ï¼Œè¿™ä¸ªç±»ä¸­å¹¶æ‰¾åˆ° doFilter() æ–¹æ³•ï¼šAbstractAuthenticationProcessingFilter bç±»</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081906611.png" srcset="/img/loading.gif" lazyload alt="image-20220808190616543" style="zoom:67%;" />

<h2 id="ä¸¤ä¸ªæ¥å£"><a href="#ä¸¤ä¸ªæ¥å£" class="headerlink" title="ä¸¤ä¸ªæ¥å£"></a>ä¸¤ä¸ªæ¥å£</h2><p>å½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä»€ä¹ˆä¹Ÿæ²¡æœ‰é…ç½®çš„æ—¶å€™ï¼Œè´¦å·å’Œå¯†ç æ˜¯ç”± Spring Security è‡ªåŠ¨ç”Ÿæˆçš„ã€‚è€Œåœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œè´¦å·å’Œå¯†ç éƒ½åº”è¯¥æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è€Œä¸æ˜¯ç”±å®ƒå¸®æˆ‘ä»¬ç”Ÿæˆã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡è‡ªå®šä¹‰é€»è¾‘æ§åˆ¶è®¤è¯é€»è¾‘</p>
<p>å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è®¤è¯é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªç±»ï¼Œè®©è¿™ä¸ªç±»ç»§æ‰¿ UsernamePasswordAuthenticationFilter è¿‡æ»¤å™¨ï¼Œåœ¨è¿™ä¸ªè¿‡æ»¤å™¨ä¸­ï¼Œæœ‰ä¸€ä¸ª attemptAuthentication() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºæ¥æ”¶ POST è¯·æ±‚è¿‡æ¥çš„å‚æ•°ï¼Œç„¶åå®ç°è®¤è¯é€»è¾‘ã€‚è€Œè®¤è¯çš„ç»“æœåªæœ‰ä¸¤ç§ç»“æœï¼šè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ã€‚è€ŒæˆåŠŸå’Œå¤±è´¥çš„é€»è¾‘æ€ä¹ˆå¤„ç†ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªè¿‡æ»¤å™¨çˆ¶ç±» AbstractAuthenticationProcessingFilter ä¸­çš„ successfulAuthentication() æ–¹æ³•å’ŒunsuccessfulAuthentication() æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ã€‚å¦‚æœè®¤è¯æˆåŠŸï¼Œä¼šè¿›å…¥ successfulAuthentication() æ–¹æ³•ï¼›å¦‚æœè®¤è¯å¤±è´¥ï¼Œä¼šè¿›å…¥unsuccessfulAuthentication() æ–¹æ³•ã€‚æˆ‘ä»¬åªéœ€è¦é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯</p>
<p>ç®€å•è¯´ï¼Œå°±æ˜¯ç¼–å†™ä¸€ä¸ªç±»ï¼Œç»§æ‰¿ UsernamePasswordAuthenticationFilter ç±»ï¼Œç„¶åé‡å†™attemptAuthentication() ã€successfulAuthentication() å’ŒunsuccessfulAuthentication() è¿™ä¸‰ä¸ªæ–¹æ³•ã€‚è€ŒæŸ¥è¯¢æ•°æ®åº“çš„æ–¹æ³•éœ€è¦å†™åœ¨ UserDetailsService è¿™ä¸ªç±»ä¸­çš„ loadUserByUsername() æ–¹æ³•ä¸­</p>
<h3 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h3><p>é™¤äº†ç¼–å†™ä¸€ä¸ªç±»ç»§æ‰¿ UsernamePasswordAuthenticationFilter å¹¶é‡å†™ä¸‰ä¸ªæ–¹æ³•å¤–ï¼Œè¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªç±»ï¼Œå®ç° UserDetailsService æ¥å£ï¼Œå¹¶é‡å†™ loadUserByUsername() æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æŸ¥è¯¢æ•°æ®åº“ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ¥å£å®šä¹‰å¦‚ä¸‹</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081909642.png" srcset="/img/loading.gif" lazyload alt="image-20220808190909584" style="zoom:67%;" />



<p>è¿™ä¸ªç±»ä¸­çš„ loadUserByUsername() æ–¹æ³•æ‰§è¡Œåï¼Œä¼šè¿”å› UserDetails å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">// è·å–ç™»å½•ç”¨æˆ·æ‰€æœ‰æƒé™</span><br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br>    <span class="hljs-comment">// è·å–å¯†ç </span><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// è·å–ç”¨æˆ·å</span><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// åˆ¤æ–­è´¦æˆ·æ˜¯å¦è¿‡æœŸ</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// åˆ¤æ–­è´¦æˆ·æ˜¯å¦è¢«é”å®š</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// åˆ¤æ–­å‡­è¯ï¼ˆå¯†ç ï¼‰æ˜¯å¦è¿‡æœŸ</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å¯ç”¨</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªç±»æ˜¯ç³»ç»Ÿé»˜è®¤çš„ç”¨æˆ·â€œä¸»ä½“â€ã€‚è¿™ä¸ªæ¥å£çš„å®ç°ç±»æœ‰</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081920352.png" srcset="/img/loading.gif" lazyload alt="image-20220808192011309"></p>
<p>åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ User è¿™ä¸ªå®ä½“ç±»å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span>, CredentialsContainer &#123;<br>    <span class="hljs-comment">//......çœç•¥</span><br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;<br>        <span class="hljs-built_in">this</span>(username, password, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, authorities);<br>    &#125;<br>    <br>    <span class="hljs-comment">//.....çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‚æ•° username è¡¨ç¤ºç”¨æˆ·åï¼Œæ­¤å€¼æ˜¯å®¢æˆ·ç«¯è¡¨å•ä¼ é€’è¿‡æ¥çš„æ•°æ®ã€‚é»˜è®¤æƒ…å†µä¸‹å¿…é¡»å« usernameï¼Œå¦åˆ™æ— æ³•æ¥æ”¶</p>
<h3 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h3><p>è¿™ä¸ªæ¥å£æ˜¯ Spring Security ä¸­ç”¨äºå¯¹å¯†ç è¿›è¡ŒåŠ å¯†çš„æ¥å£ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>    <span class="hljs-comment">// æŠŠå‚æ•°æŒ‰ç…§ç‰¹å®šçš„è§£æè§„åˆ™è¿›è¡Œè§£æ</span><br>    String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span>;<br>    <br>    <span class="hljs-comment">// éªŒè¯ä»å­˜å‚¨ä¸­è·å–çš„ç¼–ç å¯†ç ä¸ç¼–ç åæäº¤çš„åŸå§‹å¯†ç æ˜¯å¦åŒ¹é…ã€‚å¦‚æœå¯†ç åŒ¹é…åˆ™è¿”å› true;å¦‚æœä¸åŒ¹é…åˆ™è¿”å› falseã€‚ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦è¢«è§£æçš„å¯†ç ã€‚ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå­˜å‚¨çš„å¯†ç </span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span>;<br>    <br>    <span class="hljs-comment">// å¦‚æœè§£æçš„å¯†ç èƒ½å¤Ÿå†æ¬¡è¿›è¡Œè§£æä¸”è¾¾åˆ°æ›´å®‰å…¨çš„ç»“æœåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å›falseã€‚é»˜è®¤è¿”å›false</span><br>    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥å£å®ç°ç±»æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208081923475.png" srcset="/img/loading.gif" lazyload alt="image-20220808192336405" style="zoom:67%;" />



<p><strong>BCryptPasswordEncoder</strong> æ˜¯ Spring Security å®˜æ–¹æ¨èçš„å¯†ç è§£æå™¨ï¼Œå¹³æ—¶å¤šä½¿ç”¨è¿™ä¸ªè§£æå™¨</p>
<p>BCryptPasswordEncoder æ˜¯å¯¹ bcrypt å¼ºæ•£åˆ—æ–¹æ³•çš„å…·ä½“å®ç°ã€‚æ˜¯åŸºäº Hash ç®—æ³•å®ç°çš„å•å‘åŠ å¯†ã€‚å¯ä»¥é€šè¿‡ strength æ§åˆ¶åŠ å¯†å¼ºåº¦ï¼Œé»˜è®¤ 10</p>
<p><strong>ä½¿ç”¨æ¼”ç¤ºï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// åˆ›å»ºå¯†ç è§£æå™¨</span><br>    <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">bCryptPasswordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    <span class="hljs-comment">// å¯¹å¯†ç è¿›è¡ŒåŠ å¯†</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">openlab</span> <span class="hljs-operator">=</span> bCryptPasswordEncoder.encode(<span class="hljs-string">&quot;openlab&quot;</span>);<br>    <span class="hljs-comment">// æ‰“å°åŠ å¯†ä¹‹åçš„æ•°æ®</span><br>    System.out.println(<span class="hljs-string">&quot;åŠ å¯†ä¹‹åæ•°æ®ï¼š\t&quot;</span> + openlab);<br>    <span class="hljs-comment">//åˆ¤æ–­åŸå­—ç¬¦åŠ å¯†åå’ŒåŠ å¯†ä¹‹å‰æ˜¯å¦åŒ¹é…</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> bCryptPasswordEncoder.matches(<span class="hljs-string">&quot;openlab&quot;</span>, openlab);<br>    <span class="hljs-comment">// æ‰“å°æ¯”è¾ƒç»“æœ</span><br>    System.out.println(<span class="hljs-string">&quot;æ¯”è¾ƒç»“æœï¼š\t&quot;</span> + result);<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="ğŸ“’æƒé™æ–¹æ¡ˆ"><a href="#ğŸ“’æƒé™æ–¹æ¡ˆ" class="headerlink" title="ğŸ“’æƒé™æ–¹æ¡ˆ"></a>ğŸ“’æƒé™æ–¹æ¡ˆ</h1><h1 id="è‡ªå®šä¹‰è®¤è¯"><a href="#è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯"></a>è‡ªå®šä¹‰è®¤è¯</h1><p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯ Spring Security å¸®æˆ‘ä»¬ç”Ÿæˆçš„ï¼Œå¦‚æœå¸Œæœ›ç”¨æˆ·åå’Œå¯†ç æ˜¯æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼æ¥å®ç°</p>
<h2 id="é€šè¿‡é…ç½®æ–‡ä»¶"><a href="#é€šè¿‡é…ç½®æ–‡ä»¶" class="headerlink" title="é€šè¿‡é…ç½®æ–‡ä»¶"></a>é€šè¿‡é…ç½®æ–‡ä»¶</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs YML"><span class="hljs-comment"># é…ç½®ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç </span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">security:</span><br>    <span class="hljs-attr">user:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br></code></pre></td></tr></table></figure>

<h2 id="é€šè¿‡é…ç½®ç±»"><a href="#é€šè¿‡é…ç½®ç±»" class="headerlink" title="é€šè¿‡é…ç½®ç±»"></a>é€šè¿‡é…ç½®ç±»</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/5.7.1/servlet/authentication/passwords/storage.html">https://docs.spring.io/spring-security/reference/5.7.1/servlet/authentication/passwords/storage.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">chaoo</span> <span class="hljs-operator">=</span> passwordEncoder.encode(<span class="hljs-string">&quot;chaoo123&quot;</span>);<br>        <span class="hljs-comment">// åœ¨å†…å­˜ä¸­åˆ›å»ºç”¨æˆ·</span><br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        <span class="hljs-comment">// åˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·</span><br>        users.createUser(User.withUsername(<span class="hljs-string">&quot;chaoo&quot;</span>).password(chaoo).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> users;<br>    &#125;<br><br>    <span class="hljs-comment">// å¿…é¡»è¦æ³¨å…¥è¿™ä¸ªå¯¹è±¡ï¼Œè¦ä¸ç„¶ä¼šæŠ¥é”™</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>æ³¨æ„ï¼šåœ¨ SpringBoot 2.7 ä¹‹å‰æ˜¯è®©æˆ‘ä»¬çš„é…ç½®ç±»ç»§æ‰¿ WebSecurityConfigurerAdapter æŠ½è±¡ç±»ï¼Œå¹¶é‡å†™ configure(AuthenticationManagerBuilder auth) æ–¹æ³•æ¥å®ç°ã€‚ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span><br>            Exception &#123;<br>        <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">passwordEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> passwordEncoder.encode(<span class="hljs-string">&quot;openlab123&quot;</span>);<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;openlab&quot;</span>).password(password).roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½† <s><code>WebSecurityConfigurerAdapter</code></s> ç±»å·²ç»åœ¨ SpringBoot 2.7 ç‰ˆæœ¬ä¸­è¿‡æœŸäº†ï¼Œä¸æ¨èä½¿ç”¨äº†</p>
<h2 id="è‡ªå®šä¹‰ç±»"><a href="#è‡ªå®šä¹‰ç±»" class="headerlink" title="è‡ªå®šä¹‰ç±»"></a>è‡ªå®šä¹‰ç±»</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½ä¸å¤ªå®ç”¨ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸æ˜¯é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æ¥è·å–ç”¨æˆ·åå’Œå¯†ç çš„ã€‚ä¸ºäº†å®ç°è¿™ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œè®©è¿™ä¸ªç±»å®ç° UserDetailsService æ¥å£å¹¶é‡å†™ loadUserByUsername() æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ç¼–å†™æŸ¥è¯¢æ•°æ®åº“çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚æœ€åéœ€è¦æŠŠè¿™ä¸ªç±»åŠ å…¥åˆ° Spring çš„å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ä¸‹é¢æ˜¯ç®€å•æ¨¡æ‹Ÿä¸€ä¸‹æ•°æ®åº“æŸ¥è¯¢</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailService1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 1.æŸ¥è¯¢æ•°æ®åº“</span><br><br>        <span class="hljs-comment">// 2.æ ¹æ®usernameæŸ¥è¯¢æƒé™åˆ—è¡¨</span><br>        List&lt;GrantedAuthority&gt; auths = AuthorityUtils.createAuthorityList(<span class="hljs-string">&quot;role&quot;</span>);<br><br>        <span class="hljs-comment">// 3.å°è£…ç”¨æˆ·å¯¹è±¡</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;openlab&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;openlab123&quot;</span>),auths);<br><br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="æ•°æ®åº“è®¤è¯"><a href="#æ•°æ®åº“è®¤è¯" class="headerlink" title="æ•°æ®åº“è®¤è¯"></a>æ•°æ®åº“è®¤è¯</h1><p>mysql 5.7</p>
<h2 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database `springsecurity`;<br><br>use `springsecurity`;<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> users(<br>    id <span class="hljs-type">bigint</span> <span class="hljs-keyword">primary</span> key auto_increment,<br>    username <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">unique</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    password <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)<br>);<br><br><span class="hljs-comment">-- å¯†ç  openlab</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>, &quot;openlab&quot;, &quot;openlab&quot;);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>, &quot;admin&quot;, &quot;openlab&quot;);<br></code></pre></td></tr></table></figure>

<h2 id="å¼•å…¥ä¾èµ–-1"><a href="#å¼•å…¥ä¾èµ–-1" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><p>å› ä¸ºæ¶‰åŠæ•°æ®åº“ï¼Œéœ€è¦å¯¼æ•°æ®åº“ç›¸å…³çš„åŒ…	</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--å¯¼MybatisPlusåŒ…--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--å¯¼å…¥mysqlä¾èµ–--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--éœ€è¦æ›´æ”¹ç‰ˆæœ¬--&gt;</span><br>    <span class="hljs-comment">&lt;!--            &lt;version&gt;5.1.47&lt;/version&gt;--&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--å·¥å…·åŒ…--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="å®ä½“ç±»"><a href="#å®ä½“ç±»" class="headerlink" title="å®ä½“ç±»"></a>å®ä½“ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Users</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Mapperæ¥å£"><a href="#Mapperæ¥å£" class="headerlink" title="Mapperæ¥å£"></a>Mapperæ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Users&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ç¼–å†™ç™»å½•ç±»"><a href="#ç¼–å†™ç™»å½•ç±»" class="headerlink" title="ç¼–å†™ç™»å½•ç±»"></a>ç¼–å†™ç™»å½•ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 1.æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ•°æ®åº“</span><br>        QueryWrapper&lt;Users&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>        queryWrapper.eq(<span class="hljs-string">&quot;username&quot;</span>, username);<br>        <span class="hljs-type">Users</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> userMapper.selectOne(queryWrapper);<br><br>        <span class="hljs-comment">// 2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(users)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;ç”¨æˆ·åä¸å­˜åœ¨!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 3.è®¾ç½®ç”¨æˆ·çš„æƒé™</span><br>        Collection&lt;GrantedAuthority&gt; authorities<br>                = AuthorityUtils<br>                .commaSeparatedStringToAuthorityList(<span class="hljs-string">&quot;admin,role,ROLE_role,ROLE_admin&quot;</span>);<br><br>        <span class="hljs-comment">// 4.åˆ›å»ºè®¤è¯çš„å¯¹è±¡</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(users.getUsername(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(users.getPassword()),<br>                authorities);<br><br><br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.33.135:3306/springsecurity?useSSL=false</span><br><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br></code></pre></td></tr></table></figure>

<h2 id="å¯åŠ¨è¿è¡Œ"><a href="#å¯åŠ¨è¿è¡Œ" class="headerlink" title="å¯åŠ¨è¿è¡Œ"></a>å¯åŠ¨è¿è¡Œ</h2><p>æ¥ä¸‹æ¥è®¿é—®ç½‘é¡µï¼Œç”¨æˆ·çš„ç™»å½•éªŒè¯å°±æ˜¯åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æ¶ˆæ¯çš„äº†</p>
<h1 id="è‡ªå®šä¹‰ç™»å½•é¡µ"><a href="#è‡ªå®šä¹‰ç™»å½•é¡µ" class="headerlink" title="è‡ªå®šä¹‰ç™»å½•é¡µ"></a>è‡ªå®šä¹‰ç™»å½•é¡µ</h1><h2 id="å¼•å…¥ä¾èµ–-2"><a href="#å¼•å…¥ä¾èµ–-2" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h2><p>è¿™é‡Œä½¿ç”¨åˆ°äº† thymeleaf </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf ä¾èµ–--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="é…ç½®è®¤è¯"><a href="#é…ç½®è®¤è¯" class="headerlink" title="é…ç½®è®¤è¯"></a>é…ç½®è®¤è¯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin() <span class="hljs-comment">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span><br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>) <span class="hljs-comment">// ç™»å½•é¡µé¢çš„åç§°å’Œè·¯å¾„</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>) <span class="hljs-comment">// å¤„ç†ç™»å½• è¿™ä¸ªå¤„ç† SpringSecurity å·²å¯¹å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œåªé…ç½®å³å¯</span><br>                .permitAll()<br>                .and()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>).permitAll() <span class="hljs-comment">// è¿™äº›è¯·æ±‚ä¸éœ€è¦éªŒè¯</span><br>                .anyRequest().authenticated() <span class="hljs-comment">// å…¶å®ƒè¯·æ±‚éƒ½éœ€è¦è®¤è¯</span><br>                .and();<br>                .csrf().disable(); <span class="hljs-comment">// å…³é—­ csrf é˜²æŠ¤</span><br><br>        <span class="hljs-keyword">return</span> http.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208100925044.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" />

<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208100926821.png" srcset="/img/loading.gif" lazyload alt="image-20220810092618748" style="zoom:67%;" />

<h2 id="ç¼–å†™ç™»å½•é¡µ"><a href="#ç¼–å†™ç™»å½•é¡µ" class="headerlink" title="ç¼–å†™ç™»å½•é¡µ"></a>ç¼–å†™ç™»å½•é¡µ</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>ç™»å½•æ‹‰<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;account&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;openlab&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;openlab&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;æäº¤&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="å¯åŠ¨æµ‹è¯•"><a href="#å¯åŠ¨æµ‹è¯•" class="headerlink" title="å¯åŠ¨æµ‹è¯•"></a>å¯åŠ¨æµ‹è¯•</h2><p>å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•å³å¯</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªç™»å½•é¡µé¢</p>
<h1 id="æƒé™è®¿é—®æ§åˆ¶"><a href="#æƒé™è®¿é—®æ§åˆ¶" class="headerlink" title="æƒé™è®¿é—®æ§åˆ¶"></a>æƒé™è®¿é—®æ§åˆ¶</h1><h2 id="hasAuthority-æ–¹æ³•"><a href="#hasAuthority-æ–¹æ³•" class="headerlink" title="hasAuthority æ–¹æ³•"></a>hasAuthority æ–¹æ³•</h2><p>å¦‚æœå½“å‰çš„ä¸»ä½“å…·æœ‰æŒ‡å®šçš„æƒé™ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚ä¸€èˆ¬ç”¨äºåªæœ‰ä¸€ä¸ªæƒé™åœºæ™¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin() <span class="hljs-comment">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span><br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>) <span class="hljs-comment">// ç™»å½•é¡µé¢çš„åç§°å’Œè·¯å¾„</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>) <span class="hljs-comment">// å¤„ç†ç™»å½• è¿™ä¸ªå¤„ç† SpringSecurity å·²å¯¹å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œåªé…ç½®å³å¯</span><br>            	.successForwardUrl(<span class="hljs-string">&quot;/success&quot;</span>) <span class="hljs-comment">// ç™»å½•æˆåŠŸåå¤„ç†çš„è¯·æ±‚</span><br>                .usernameParameter(<span class="hljs-string">&quot;account&quot;</span>)<span class="hljs-comment">// è‡ªå®šä¹‰ç”¨æˆ·å</span><br>                .failureForwardUrl(<span class="hljs-string">&quot;/failure&quot;</span>) <span class="hljs-comment">// ç™»é™†å¤±è´¥åå¤„ç†çš„è¯·æ±‚    </span><br>            	.permitAll()<br>                .and()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>).permitAll() <span class="hljs-comment">// è¿™äº›è¯·æ±‚ä¸éœ€è¦éªŒè¯</span><br>                <br>            	.antMatchers(<span class="hljs-string">&quot;/find&quot;</span>).hasAuthority(<span class="hljs-string">&quot;admin1&quot;</span>) <span class="hljs-comment">// éœ€è¦adminæƒé™</span><br>            <br>          		.anyRequest().authenticated() <span class="hljs-comment">// å…¶å®ƒè¯·æ±‚éƒ½éœ€è¦è®¤è¯</span><br>                .and();<br>                .csrf().disable(); <span class="hljs-comment">// å…³é—­ csrf é˜²æŠ¤</span><br><br>        <span class="hljs-keyword">return</span> http.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨æ§åˆ¶å™¨é‡Œæ·»åŠ  find æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/find&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">find</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;find&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨æµ‹è¯•</p>
<h2 id="hasAnyAuthority-æ–¹æ³•"><a href="#hasAnyAuthority-æ–¹æ³•" class="headerlink" title="hasAnyAuthority æ–¹æ³•"></a>hasAnyAuthority æ–¹æ³•</h2><p>å¦‚æœå½“å‰çš„ä¸»ä½“æœ‰ä»»ä½•æä¾›çš„è§’è‰²ï¼ˆç»™å®šçš„ä½œä¸ºä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼‰çš„è¯ï¼Œè¿”å› trueã€‚ä¸€èˆ¬ç”¨äºä¸€ä¸ªæˆ–å¤šä¸ªæƒé™åœºæ™¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin() <span class="hljs-comment">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span><br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>) <span class="hljs-comment">// ç™»å½•é¡µé¢çš„åç§°å’Œè·¯å¾„</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>) <span class="hljs-comment">// å¤„ç†ç™»å½• è¿™ä¸ªå¤„ç† SpringSecurity å·²å¯¹å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œåªé…ç½®å³å¯</span><br>            	.successForwardUrl(<span class="hljs-string">&quot;/success&quot;</span>) <span class="hljs-comment">// ç™»å½•æˆåŠŸåå¤„ç†çš„è¯·æ±‚</span><br>                .usernameParameter(<span class="hljs-string">&quot;account&quot;</span>)<span class="hljs-comment">// è‡ªå®šä¹‰ç”¨æˆ·å</span><br>                .failureForwardUrl(<span class="hljs-string">&quot;/failure&quot;</span>) <span class="hljs-comment">// ç™»é™†å¤±è´¥åå¤„ç†çš„è¯·æ±‚    </span><br>            	.permitAll()<br>                .and()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>).permitAll() <span class="hljs-comment">// è¿™äº›è¯·æ±‚ä¸éœ€è¦éªŒè¯</span><br>                <br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasAuthority(&quot;admin1&quot;) // éœ€è¦adminæƒé™</span><br>            	.antMatchers(<span class="hljs-string">&quot;/find&quot;</span>).hasAnyAuthority(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;role&quot;</span>) <span class="hljs-comment">// å¦‚æœç”¨æˆ·å¸¦æœ‰æŒ‡å®šä»»ä½•ä¸€ä¸ªæƒé™å°±å¯ä»¥</span><br>            <br>          		.anyRequest().authenticated() <span class="hljs-comment">// å…¶å®ƒè¯·æ±‚éƒ½éœ€è¦è®¤è¯</span><br>                .and();<br>                .csrf().disable(); <span class="hljs-comment">// å…³é—­ csrf é˜²æŠ¤</span><br><br>        <span class="hljs-keyword">return</span> http.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="hasRole-æ–¹æ³•"><a href="#hasRole-æ–¹æ³•" class="headerlink" title="hasRole æ–¹æ³•"></a>hasRole æ–¹æ³•</h2><p>å¦‚æœç”¨æˆ·å…·å¤‡ç»™å®šè§’è‰²å°±å…è®¸è®¿é—®ï¼Œå¦åˆ™å‡ºç° 403ã€‚ å¦‚æœå½“å‰ä¸»ä½“å…·æœ‰æŒ‡å®šçš„è§’è‰²ï¼Œåˆ™è¿”å› trueã€‚ åº•å±‚æºç </p>
<p>ä¿®æ”¹å¤„ç†è®¤è¯ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>    <span class="hljs-comment">// 1.æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ•°æ®åº“</span><br>    QueryWrapper&lt;Users&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>    queryWrapper.eq(<span class="hljs-string">&quot;username&quot;</span>, username);<br>    <span class="hljs-type">Users</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> userMapper.selectOne(queryWrapper);<br><br>    <span class="hljs-comment">// 2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(users)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;ç”¨æˆ·åä¸å­˜åœ¨!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 3.è®¾ç½®ç”¨æˆ·çš„æƒé™</span><br>    Collection&lt;GrantedAuthority&gt; authorities<br>        = AuthorityUtils<br>        .commaSeparatedStringToAuthorityList(<span class="hljs-string">&quot;admin,ROLE_role&quot;</span>);<br><br>    <span class="hljs-comment">// 4.åˆ›å»ºè®¤è¯çš„å¯¹è±¡</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(users.getUsername(),<br>                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(users.getPassword()),<br>                         authorities);<br><br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šåœ¨æŒ‡å®šè§’è‰²æ—¶ï¼Œéœ€è¦åœ¨è§’è‰²åç§°å‰é¢æ·»åŠ  ROLE_ å‰ç¼€</strong></p>
<p>ä¿®æ”¹é…ç½®ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin() <span class="hljs-comment">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span><br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>) <span class="hljs-comment">// ç™»å½•é¡µé¢çš„åç§°å’Œè·¯å¾„</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>) <span class="hljs-comment">// å¤„ç†ç™»å½• è¿™ä¸ªå¤„ç† SpringSecurity å·²å¯¹å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œåªé…ç½®å³å¯</span><br>            	.successForwardUrl(<span class="hljs-string">&quot;/success&quot;</span>) <span class="hljs-comment">// ç™»å½•æˆåŠŸåå¤„ç†çš„è¯·æ±‚</span><br>                .usernameParameter(<span class="hljs-string">&quot;account&quot;</span>)<span class="hljs-comment">// è‡ªå®šä¹‰ç”¨æˆ·å</span><br>                .failureForwardUrl(<span class="hljs-string">&quot;/failure&quot;</span>) <span class="hljs-comment">// ç™»é™†å¤±è´¥åå¤„ç†çš„è¯·æ±‚    </span><br>            	.permitAll()<br>                .and()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>).permitAll() <span class="hljs-comment">// è¿™äº›è¯·æ±‚ä¸éœ€è¦éªŒè¯</span><br>                <br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasAuthority(&quot;admin1&quot;) // éœ€è¦adminæƒé™</span><br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasAnyAuthority(&quot;admin&quot;,&quot;role&quot;) // å¦‚æœç”¨æˆ·å¸¦æœ‰æŒ‡å®šä»»ä½•ä¸€ä¸ªæƒé™å°±å¯ä»¥</span><br>            	.antMatchers(<span class="hljs-string">&quot;/find&quot;</span>).hasRole(<span class="hljs-string">&quot;role&quot;</span>) <span class="hljs-comment">// éœ€è¦ç”¨æˆ·å¸¦æœ‰ role   è§’è‰²æ‰å¯ä»¥</span><br>            <br>          		.anyRequest().authenticated() <span class="hljs-comment">// å…¶å®ƒè¯·æ±‚éƒ½éœ€è¦è®¤è¯</span><br>                .and();<br>                .csrf().disable(); <span class="hljs-comment">// å…³é—­ csrf é˜²æŠ¤</span><br><br>        <span class="hljs-keyword">return</span> http.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="hasAnyRole-æ–¹æ³•"><a href="#hasAnyRole-æ–¹æ³•" class="headerlink" title="hasAnyRole æ–¹æ³•"></a>hasAnyRole æ–¹æ³•</h2><p>è¡¨ç¤ºç”¨æˆ·å…·å¤‡ä»»ä½•ä¸€ä¸ªè§’è‰²éƒ½å¯ä»¥è®¿é—®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>    <span class="hljs-comment">// 1.æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ•°æ®åº“</span><br>    QueryWrapper&lt;Users&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>    queryWrapper.eq(<span class="hljs-string">&quot;username&quot;</span>, username);<br>    <span class="hljs-type">Users</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> userMapper.selectOne(queryWrapper);<br><br>    <span class="hljs-comment">// 2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(users)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;ç”¨æˆ·åä¸å­˜åœ¨!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 3.è®¾ç½®ç”¨æˆ·çš„æƒé™</span><br>    Collection&lt;GrantedAuthority&gt; authorities<br>        = AuthorityUtils<br>        .commaSeparatedStringToAuthorityList(<span class="hljs-string">&quot;admin,role,ROLE_role,ROLE_admin&quot;</span>);<br><br>    <span class="hljs-comment">// 4.åˆ›å»ºè®¤è¯çš„å¯¹è±¡</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(users.getUsername(),<br>                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(users.getPassword()),<br>                         authorities);<br><br><br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.formLogin() <span class="hljs-comment">// è‡ªå®šä¹‰ç™»å½•é¡µé¢</span><br>                .loginPage(<span class="hljs-string">&quot;/login.html&quot;</span>) <span class="hljs-comment">// ç™»å½•é¡µé¢çš„åç§°å’Œè·¯å¾„</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login&quot;</span>) <span class="hljs-comment">// å¤„ç†ç™»å½• è¿™ä¸ªå¤„ç† SpringSecurity å·²å¯¹å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œåªé…ç½®å³å¯</span><br>            	.successForwardUrl(<span class="hljs-string">&quot;/success&quot;</span>) <span class="hljs-comment">// ç™»å½•æˆåŠŸåå¤„ç†çš„è¯·æ±‚</span><br>                .usernameParameter(<span class="hljs-string">&quot;account&quot;</span>)<span class="hljs-comment">// è‡ªå®šä¹‰ç”¨æˆ·å</span><br>                .failureForwardUrl(<span class="hljs-string">&quot;/failure&quot;</span>) <span class="hljs-comment">// ç™»é™†å¤±è´¥åå¤„ç†çš„è¯·æ±‚    </span><br>            	.permitAll()<br>                .and()<br>                .authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>).permitAll() <span class="hljs-comment">// è¿™äº›è¯·æ±‚ä¸éœ€è¦éªŒè¯</span><br>                <br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasAuthority(&quot;admin1&quot;) // éœ€è¦adminæƒé™</span><br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasAnyAuthority(&quot;admin&quot;,&quot;role&quot;) // å¦‚æœç”¨æˆ·å¸¦æœ‰æŒ‡å®šä»»ä½•ä¸€ä¸ªæƒé™å°±å¯ä»¥</span><br>            	<span class="hljs-comment">// .antMatchers(&quot;/find&quot;).hasRole(&quot;role&quot;) // éœ€è¦ç”¨æˆ·å¸¦æœ‰ role   è§’è‰²æ‰å¯ä»¥</span><br>            	.antMatchers(<span class="hljs-string">&quot;/find&quot;</span>).hasAnyRole(<span class="hljs-string">&quot;role1&quot;</span>, <span class="hljs-string">&quot;admin1&quot;</span>) <span class="hljs-comment">// éœ€è¦ç”¨æˆ·å¸¦ä»»æ„æŒ‡å®šè§’è‰²æ‰å¯è®¿é—®</span><br>          		.anyRequest().authenticated() <span class="hljs-comment">// å…¶å®ƒè¯·æ±‚éƒ½éœ€è¦è®¤è¯</span><br>                .and();<br>                .csrf().disable(); <span class="hljs-comment">// å…³é—­ csrf é˜²æŠ¤</span><br><br>        <span class="hljs-keyword">return</span> http.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="è‡ªå®šä¹‰-403-ç•Œé¢"><a href="#è‡ªå®šä¹‰-403-ç•Œé¢" class="headerlink" title="è‡ªå®šä¹‰ 403 ç•Œé¢"></a>è‡ªå®šä¹‰ 403 ç•Œé¢</h2><p>å½“æ²¡æœ‰æƒé™æˆ–è€…æ‹¥æœ‰ç›¸åº”çš„è§’è‰²æ—¶ï¼Œå¦‚æœè®¿é—®åˆ™ä¼šæŠ¥ 403 é”™è¯¯ï¼Œå¹¶è½¬åˆ° 403 é¡µé¢ã€‚è¿™ä¸ªé¡µé¢æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰</p>
<p>é¦–å…ˆåœ¨ resources ç›®å½•ä¸‹æ–°å»º static ç›®å½•ï¼Œå¹¶åœ¨ç›®å½•ä¸­æ–°å»º unauth.html é¡µé¢ï¼Œç”¨äºæ˜¾ç¤º 403 é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>æ— æƒè®¿é—®<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>ä½ æ²¡æƒé™å“‡,è¿›ä¸å»è¿™é‡Œ<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>é…ç½®é¡µé¢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//........</span><br>    <br>    http.exceptionHandling().accessDeniedPage(<span class="hljs-string">&quot;/unauth.html&quot;</span>); <span class="hljs-comment">// é…ç½®æ— æƒé™è®¿é—®é¡µé¢</span><br>    <br>    <span class="hljs-keyword">return</span> http.build();<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="æ³¨è§£ä½¿ç”¨"><a href="#æ³¨è§£ä½¿ç”¨" class="headerlink" title="æ³¨è§£ä½¿ç”¨"></a>æ³¨è§£ä½¿ç”¨</h1><h2 id="Secured"><a href="#Secured" class="headerlink" title="@Secured"></a>@Secured</h2><p>åˆ¤æ–­æ˜¯å¦å…·æœ‰è§’è‰²ï¼Œå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡ŒåŒ¹é…çš„å­—ç¬¦ä¸²éœ€è¦æ·»åŠ å‰ç¼€ <strong>â€œROLE_â€</strong></p>
<p>è¦æƒ³ä½¿ç”¨æ³¨è§£ï¼Œéœ€è¦å¯åŠ¨ç±»ä¸Šå…ˆå¼€å¯æ³¨è§£åŠŸèƒ½æ”¯æŒ <code>@EnableGlobalMethodSecurity(securedEnabled=true) </code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.chaoo.mapper&quot;)</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(securedEnabled = true)</span> <span class="hljs-comment">// å¼€å¯æ³¨è§£è§’è‰²æ”¯æŒ</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SecurityApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Secured(&#123;&quot;ROLE_role&quot;,&quot;ROLE_admin&quot;&#125;)</span><br><span class="hljs-meta">@GetMapping(&quot;/find&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">find</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;find&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="PreAuthorize"><a href="#PreAuthorize" class="headerlink" title="@PreAuthorize"></a>@PreAuthorize</h2><p>å…ˆå¼€å¯æ³¨è§£åŠŸèƒ½ï¼š <code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code></p>
<p>@PreAuthorize æ³¨è§£é€‚åˆè¿›å…¥æ–¹æ³•å‰çš„æƒé™éªŒè¯ï¼Œ@PreAuthorize å¯ä»¥å°†ç™»å½•ç”¨æˆ·çš„ roles&#x2F;permissions å‚æ•°ä¼ åˆ°æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//@PreAuthorize(&quot;hasAuthority(&#x27;admin&#x27;)&quot;)</span><br><span class="hljs-comment">//@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;,&#x27;role&#x27;)&quot;)</span><br><span class="hljs-comment">//@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;)&quot;)</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAnyRole(&#x27;admin&#x27;, &#x27;role&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/find&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">find</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;find&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="PostAuthorize"><a href="#PostAuthorize" class="headerlink" title="@PostAuthorize"></a>@PostAuthorize</h2><p>å…ˆå¼€å¯æ³¨è§£åŠŸèƒ½ï¼š @EnableGlobalMethodSecurity(prePostEnabled &#x3D; true)</p>
<p>@PostAuthorize æ³¨è§£ä½¿ç”¨å¹¶ä¸å¤šï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹åå†è¿›è¡Œæƒé™éªŒè¯ï¼Œé€‚åˆéªŒè¯å¸¦æœ‰è¿”å›å€¼çš„æƒé™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostAuthorize(&quot;hasAnyRole(&#x27;normal&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span> &#123;<br>    List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>, <span class="hljs-string">&quot;æå››&quot;</span>, <span class="hljs-string">&quot;ç‹äº”&quot;</span>);<br>    System.out.println(names);<br>    <span class="hljs-keyword">return</span> names;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="ç”¨æˆ·æ³¨é”€"><a href="#ç”¨æˆ·æ³¨é”€" class="headerlink" title="ç”¨æˆ·æ³¨é”€"></a>ç”¨æˆ·æ³¨é”€</h1><h2 id="é€€å‡ºé“¾æ¥"><a href="#é€€å‡ºé“¾æ¥" class="headerlink" title="é€€å‡ºé“¾æ¥"></a>é€€å‡ºé“¾æ¥</h2><p>åœ¨ success.html é¡µé¢ä¸­æ·»åŠ é€€å‡ºç™»å½•é“¾æ¥</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•æˆåŠŸ<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/logout&quot;</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="é…ç½®æ˜ å°„"><a href="#é…ç½®æ˜ å°„" class="headerlink" title="é…ç½®æ˜ å°„"></a>é…ç½®æ˜ å°„</h2><p>åœ¨é…ç½®ç±»ä¸­é…ç½®é€€å‡ºé“¾æ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-comment">//.......</span><br>    http.logout().logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>).logoutSuccessUrl(<span class="hljs-string">&quot;/&quot;</span>).permitAll();<br>    <span class="hljs-keyword">return</span> http.build();<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><strong>è·¨ç«™è¯·æ±‚ä¼ªé€ </strong>ï¼ˆè‹±è¯­ï¼šCross-site request forgeryï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸º <strong>one-click attack</strong> æˆ–è€… <strong>session riding</strong>ï¼Œé€šå¸¸ç¼©å†™ä¸º <strong>CSRF</strong> æˆ–è€… <strong>XSRF</strong>ï¼Œ æ˜¯ä¸€ç§æŒŸåˆ¶ç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„ Web åº”ç”¨ç¨‹åºä¸Šæ‰§è¡Œéæœ¬æ„çš„æ“ä½œçš„æ”»å‡»æ–¹æ³•ã€‚è·Ÿ<strong>è·¨ç½‘ç«™è„šæœ¬</strong>ï¼ˆXSSï¼‰ç›¸æ¯”ï¼Œ<strong>XSS</strong> åˆ©ç”¨çš„æ˜¯ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼Œ CSRF åˆ©ç”¨çš„æ˜¯ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»</p>
<p>è·¨ç«™è¯·æ±‚æ”»å‡»ï¼Œç®€å•åœ°è¯´ï¼Œæ˜¯æ”»å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨å»è®¿é—®ä¸€ä¸ªè‡ªå·±æ›¾ç»è®¤è¯è¿‡çš„ç½‘ç«™å¹¶è¿è¡Œä¸€äº›æ“ä½œï¼ˆå¦‚å‘é‚®ä»¶ï¼Œå‘æ¶ˆæ¯ï¼Œç”šè‡³è´¢äº§æ“ä½œå¦‚è½¬è´¦å’Œè´­ä¹° å•†å“ï¼‰ã€‚ç”±äºæµè§ˆå™¨æ›¾ç»è®¤è¯è¿‡ï¼Œæ‰€ä»¥è¢«è®¿é—®çš„ç½‘ç«™ä¼šè®¤ä¸ºæ˜¯çœŸæ­£çš„ç”¨æˆ·æ“ä½œè€Œå»è¿è¡Œã€‚ è¿™åˆ©ç”¨äº† web ä¸­ç”¨æˆ·èº«ä»½éªŒè¯çš„ä¸€ä¸ªæ¼æ´ï¼š<strong>ç®€å•çš„èº«ä»½éªŒè¯åªèƒ½ä¿è¯è¯·æ±‚å‘è‡ªæŸä¸ªç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå´ä¸èƒ½ä¿è¯è¯·æ±‚æœ¬èº«æ˜¯ç”¨æˆ·è‡ªæ„¿å‘å‡ºçš„</strong>ã€‚</p>
<p>ä» Spring Security 4.0 å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šå¯ç”¨ CSRF ä¿æŠ¤ï¼Œä»¥é˜²æ­¢ CSRF æ”»å‡»åº”ç”¨ç¨‹åºï¼ŒSpring Security CSRF ä¼šé’ˆå¯¹ PATCHï¼ŒPOSTï¼ŒPUT å’Œ DELETE æ–¹æ³•è¿›è¡Œé˜²æŠ¤</p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--å¯¹Thymeleafæ·»åŠ Spring Securityæ ‡ç­¾æ”¯æŒ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ç™»å½•é¡µé¢æ·»åŠ ä¸€ä¸ªéšè—åŸŸï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>ç™»å½•é¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">th:name</span>=<span class="hljs-string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;_csrf.token&#125;&quot;</span>&gt;</span><br>    ç”¨æˆ·åï¼š<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;account&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;openlab&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    å¯†ç ï¼š<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;openlab&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ç™»å½•&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>å…³é—­æ¡ˆä¾‹é…ç½®çš„ç±»ä¸­çš„ csrf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//.csrf().disable(); // å…³é—­ csrf é˜²æŠ¤</span><br></code></pre></td></tr></table></figure>

<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>ç”Ÿæˆ csrfToken ä¿å­˜åˆ° HttpSession æˆ–è€… Cookie ä¸­</p>
<p><img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208101020768.png" srcset="/img/loading.gif" lazyload alt="image-20220810102044685"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CsrfToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String <span class="hljs-title function_">getHeaderName</span><span class="hljs-params">()</span>;<br>    String <span class="hljs-title function_">getParameterName</span><span class="hljs-params">()</span>;<br>    String <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SaveOnAccessCsrfToken ç±»æœ‰ä¸ªæ¥å£ CsrfTokenRepository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaveOnAccessCsrfToken</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CsrfToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> CsrfTokenRepository tokenRepository;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> HttpServletRequest request;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> HttpServletResponse response;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CsrfToken delegate;<br></code></pre></td></tr></table></figure>

<img src="https://sansisuifeng-img.oss-cn-beijing.aliyuncs.com/img/202208101022493.png" srcset="/img/loading.gif" lazyload alt="image-20220810102232416" style="zoom:67%;" />

<p>å½“å‰æ¥å£å®ç°ç±»ï¼šHttpSessionCsrfTokenRepositoryï¼ŒCookieCsrfTokenRepository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CookieCsrfTokenRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CsrfTokenRepository</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_CSRF_COOKIE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;XSRF-TOKEN&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_CSRF_PARAMETER_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;_csrf&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_CSRF_HEADER_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;X-XSRF-TOKEN&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">parameterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;_csrf&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">headerName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;X-XSRF-TOKEN&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">cookieName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;XSRF-TOKEN&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cookieHttpOnly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">private</span> String cookiePath;<br>    <span class="hljs-keyword">private</span> String cookieDomain;<br>    <span class="hljs-keyword">private</span> Boolean secure;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">cookieMaxAge</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CookieCsrfTokenRepository</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> CsrfToken <span class="hljs-title function_">generateToken</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-comment">// åˆ›å»º DefaultCsrfToken å¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCsrfToken</span>(<span class="hljs-built_in">this</span>.headerName, <span class="hljs-built_in">this</span>.parameterName,<span class="hljs-built_in">this</span>.createNewToken());<br>    &#125;<br>    <br>    <span class="hljs-comment">//......çœç•¥</span><br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">createNewToken</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> UUID.randomUUID().toString();<br>    &#125;<br>    <br>    <span class="hljs-comment">//......çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä»è¯·æ±‚ä¸­æå– csrfTokenï¼Œå’Œä¿å­˜çš„ csrfToken åšæ¯”è¾ƒï¼Œè¿›è€Œåˆ¤æ–­å½“ å‰è¯·æ±‚æ˜¯å¦åˆæ³•ã€‚ä¸»è¦é€šè¿‡ CsrfFilter è¿‡æ»¤å™¨æ¥å®Œæˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CsrfFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RequestMatcher</span> <span class="hljs-variable">DEFAULT_CSRF_MATCHER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRequiresCsrfMatcher</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SHOULD_NOT_FILTER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SHOULD_NOT_FILTER&quot;</span> +<br>            CsrfFilter.class.getName();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CsrfTokenRepository tokenRepository;<br>    <span class="hljs-keyword">private</span> RequestMatcher requireCsrfProtectionMatcher;<br>    <span class="hljs-keyword">private</span> AccessDeniedHandler accessDeniedHandler;<br><br>    <span class="hljs-comment">//.....çœç•¥</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        request.setAttribute(HttpServletResponse.class.getName(), response);<br>        <span class="hljs-type">CsrfToken</span> <span class="hljs-variable">csrfToken</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tokenRepository.loadToken(request);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">missingToken</span> <span class="hljs-operator">=</span> csrfToken == <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (missingToken) &#123;<br>            csrfToken = <span class="hljs-built_in">this</span>.tokenRepository.generateToken(request);<br>            <span class="hljs-built_in">this</span>.tokenRepository.saveToken(csrfToken, request, response);<br>        &#125;<br>        request.setAttribute(CsrfToken.class.getName(), csrfToken); <span class="hljs-comment">// è¿™ä¸ª key</span><br>        å°±æ˜¯ _csrfï¼Œvalue å°±æ˜¯ token<br>        request.setAttribute(csrfToken.getParameterName(), csrfToken);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.requireCsrfProtectionMatcher.matches(request)) &#123; <span class="hljs-comment">// æ­¤å¤„å°±æ˜¯éªŒè¯</span><br>            æ˜¯å¦åŒ¹é…æ­£ç¡®<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>                <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Did not protect against CSRF since request</span><br><span class="hljs-string">                        did not match &quot;</span> + <span class="hljs-built_in">this</span>.requireCsrfProtectionMatcher);<br>            &#125;<br>            filterChain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//.....çœç•¥</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//......................</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="ğŸ“’æºç â³"><a href="#ğŸ“’æºç â³" class="headerlink" title="ğŸ“’æºç â³"></a>ğŸ“’æºç â³</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/SpringSecurity/" class="category-chain-item">SpringSecurity</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/SpringBoot/">#SpringBoot</a>
      
        <a href="/tags/Spring/">#Spring</a>
      
        <a href="/tags/SpringSecurity/">#SpringSecurity</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringSecurity</div>
      <div>http://example.com/2022/08/06/2022-8-6-SpringSecurity/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Chaoo</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´8æœˆ6æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/10/2022-8-10-ejyy/" title="eå®¶å®œä¸š">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">eå®¶å®œä¸š</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/01/2022-8-1-%E5%90%84%E7%A7%8D%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0/" title="æœåŠ¡å¯åŠ¨æŒ‡ä»¤åŠä½ç½®">
                        <span class="hidden-mobile">æœåŠ¡å¯åŠ¨æŒ‡ä»¤åŠä½ç½®</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
